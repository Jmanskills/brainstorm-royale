<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BrainStorm Royale</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="character-renderer.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Arial', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      overflow: hidden;
      height: 100vh;
    }

    /* ========== MODAL SYSTEM ========== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: #ff4444;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-size: 20px;
      line-height: 30px;
    }

    .modal-close:hover {
      background: #cc0000;
    }

    /* ========== AUTH SCREEN ========== */
    #auth-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100vw;
    }

    .auth-container {
      background: rgba(255, 255, 255, 0.95);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 90%;
    }

    .auth-title {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
      text-align: center;
      margin-bottom: 10px;
    }

    .auth-subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
    }

    .auth-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
    }

    .auth-tab {
      flex: 1;
      padding: 12px;
      border: none;
      background: #f0f0f0;
      cursor: pointer;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s;
    }

    .auth-tab.active {
      background: #667eea;
      color: white;
    }

    .auth-form {
      display: none;
    }

    .auth-form.active {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      transition: border 0.3s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .auth-button {
      width: 100%;
      padding: 15px;
      border: none;
      background: #667eea;
      color: white;
      font-size: 16px;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .auth-button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .guest-button {
      width: 100%;
      padding: 15px;
      border: 2px solid #667eea;
      background: white;
      color: #667eea;
      font-size: 16px;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.3s;
    }

    .guest-button:hover {
      background: #f8f8ff;
    }

    .error-message {
      background: #ff4444;
      color: white;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
    }

    .success-message {
      background: #44ff44;
      color: white;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
    }

    /* ========== MENU SCREEN ========== */
    #menu-screen {
      display: none;
      height: 100vh;
      width: 100vw;
      position: relative;
    }

    .top-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      z-index: 100;
    }

    .top-bar-left {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .top-bar-right {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .top-button {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .top-button:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .coins-display {
      background: rgba(255, 215, 0, 0.3);
      border: 2px solid gold;
      padding: 8px 16px;
      border-radius: 8px;
      color: gold;
      font-weight: bold;
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff4444;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .notification-badge.active {
      display: flex;
    }

    .menu-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 500px;
      width: 90%;
      text-align: center;
    }

    .game-title {
      font-size: 48px;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }

    .game-subtitle {
      color: #666;
      font-size: 18px;
      margin-bottom: 30px;
    }

    .user-info {
      background: #f8f8ff;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 30px;
      border: 2px solid #667eea;
    }

    .user-stats {
      display: flex;
      justify-content: space-around;
      margin-top: 10px;
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
    }

    .menu-buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .menu-button {
      padding: 18px;
      border: none;
      border-radius: 15px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .primary-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
    }

    .primary-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 30px rgba(102, 126, 234, 0.4);
    }

    .secondary-button {
      background: white;
      color: #667eea;
      border: 3px solid #667eea;
    }

    .secondary-button:hover {
      background: #f8f8ff;
      transform: translateY(-2px);
    }

    /* ========== FRIENDS SIDEBAR ========== */
    .friends-sidebar {
      position: absolute;
      right: 0;
      top: 60px;
      bottom: 0;
      width: 300px;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: -5px 0 20px rgba(0,0,0,0.2);
      transform: translateX(100%);
      transition: transform 0.3s;
      z-index: 50;
      overflow-y: auto;
    }

    .friends-sidebar.open {
      transform: translateX(0);
    }

    .friends-header {
      padding: 20px;
      background: #667eea;
      color: white;
      font-size: 20px;
      font-weight: bold;
    }

    .friends-tabs {
      display: flex;
      background: #f0f0f0;
    }

    .friends-tab {
      flex: 1;
      padding: 12px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }

    .friends-tab.active {
      background: white;
      color: #667eea;
    }

    .friends-content {
      padding: 15px;
    }

    .friend-search {
      margin-bottom: 15px;
    }

    .friend-search input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
    }

    .friend-item {
      background: #f8f8ff;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .friend-info {
      flex: 1;
    }

    .friend-name {
      font-weight: bold;
      color: #333;
    }

    .friend-status {
      font-size: 12px;
      color: #666;
    }

    .online-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #44ff44;
      display: inline-block;
      margin-right: 5px;
    }

    .offline-indicator {
      background: #999;
    }

    .friend-actions {
      display: flex;
      gap: 5px;
    }

    .friend-button {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
    }

    .invite-button {
      background: #667eea;
      color: white;
    }

    .accept-button {
      background: #44ff44;
      color: white;
    }

    .decline-button {
      background: #ff4444;
      color: white;
    }

    /* ========== PARTY PANEL ========== */
    .party-panel {
      position: absolute;
      left: 20px;
      bottom: 20px;
      width: 250px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      display: none;
    }

    .party-panel.active {
      display: block;
    }

    .party-header {
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .party-member {
      background: #f8f8ff;
      padding: 8px;
      border-radius: 6px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .party-member.ready {
      border: 2px solid #44ff44;
    }

    .party-member.leader {
      border: 2px solid gold;
    }

    /* ========== BATTLE TICKET MODAL ========== */
    .battle-ticket-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .season-title {
      font-size: 28px;
      font-weight: bold;
      color: #667eea;
    }

    .tier-display {
      font-size: 48px;
      font-weight: bold;
      color: #764ba2;
      margin: 10px 0;
    }

    .xp-progress {
      background: #e0e0e0;
      height: 20px;
      border-radius: 10px;
      overflow: hidden;
      margin: 15px 0;
    }

    .xp-bar {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      height: 100%;
      transition: width 0.3s;
    }

    .premium-banner {
      background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
      color: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      margin: 20px 0;
      cursor: pointer;
    }

    .reward-tiers {
      max-height: 400px;
      overflow-y: auto;
    }

    .reward-tier {
      background: #f8f8ff;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      border: 2px solid #e0e0e0;
    }

    .reward-tier.locked {
      opacity: 0.5;
    }

    .reward-tier.claimed {
      background: #e0e0e0;
    }

    .tier-number {
      font-weight: bold;
      color: #667eea;
      font-size: 18px;
    }

    .tier-rewards {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .reward-item {
      background: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      border: 2px solid #667eea;
    }

    .reward-item.premium {
      border-color: gold;
      background: #fff9e6;
    }

    .claim-button {
      margin-top: 10px;
      padding: 10px 20px;
      background: #44ff44;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }

    /* ========== CHAT WINDOW ========== */
    .chat-window {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 350px;
      height: 300px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 10px;
      display: none;
      flex-direction: column;
    }

    .chat-window.active {
      display: flex;
    }

    .chat-header {
      padding: 10px;
      background: rgba(102, 126, 234, 0.5);
      border-radius: 10px 10px 0 0;
      color: white;
      font-weight: bold;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      color: white;
    }

    .chat-message {
      margin-bottom: 8px;
      padding: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    .chat-username {
      font-weight: bold;
      color: #667eea;
    }

    .chat-input-container {
      padding: 10px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 0 0 10px 10px;
    }

    .chat-input {
      width: 100%;
      padding: 8px;
      border: none;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.9);
    }

    /* ========== VOICE CHAT CONTROLS ========== */
    .voice-controls {
      position: absolute;
      top: 70px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px;
      border-radius: 10px;
      color: white;
      display: none;
    }

    .voice-controls.active {
      display: block;
    }

    .voice-button {
      padding: 10px 20px;
      border: 2px solid white;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
      transition: all 0.3s;
    }

    .voice-button.active {
      background: #44ff44;
      border-color: #44ff44;
      color: black;
    }

    .voice-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #ff4444;
      margin-right: 8px;
    }

    .voice-indicator.speaking {
      background: #44ff44;
      animation: pulse 0.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* ========== SETTINGS MODAL ========== */
    .settings-section {
      margin-bottom: 25px;
    }

    .settings-section h3 {
      color: #667eea;
      margin-bottom: 15px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 5px;
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f8f8ff;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
      background: #ccc;
      border-radius: 13px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch.active {
      background: #667eea;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 22px;
      height: 22px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: left 0.3s;
    }

    .toggle-switch.active::after {
      left: 26px;
    }

    .warning-box {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }

    .warning-box h4 {
      color: #856404;
      margin-bottom: 10px;
    }

    .warning-box p {
      color: #856404;
      font-size: 14px;
    }

    /* ========== LOBBY/GAME/POSTGAME (keeping existing styles) ========== */
    #lobby-screen, #game-screen, #postgame-screen {
      display: none;
    }

    .hidden {
      display: none !important;
    }

    /* Utility */
    .text-center {
      text-align: center;
    }

    .mb-10 {
      margin-bottom: 10px;
    }

    .mt-20 {
      margin-top: 20px;
    }
    /* ========== SHOP STYLES ========== */
    .shop-tab {
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      padding: 12px 20px;
      font-size: 16px;
      cursor: pointer;
      color: #666;
      transition: all 0.3s;
    }

    .shop-tab:hover {
      color: #667eea;
    }

    .shop-tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
      font-weight: bold;
    }

    .shop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      padding: 20px 0;
    }

    .shop-item {
      background: white;
      border: 2px solid #ddd;
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
    }

    .shop-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      border-color: #667eea;
    }

    .shop-item.owned {
      border-color: #2ecc71;
      background: #f0fff4;
    }

    .shop-item-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .shop-item-name {
      font-weight: bold;
      font-size: 16px;
      color: #333;
      margin-bottom: 5px;
    }

    .shop-item-rarity {
      font-size: 12px;
      padding: 4px 12px;
      border-radius: 12px;
      display: inline-block;
      margin-bottom: 10px;
    }

    .rarity-common { background: #95a5a6; color: white; }
    .rarity-uncommon { background: #27ae60; color: white; }
    .rarity-rare { background: #3498db; color: white; }
    .rarity-epic { background: #9b59b6; color: white; }
    .rarity-legendary { background: #f39c12; color: white; }

    .shop-item-price {
      font-size: 20px;
      font-weight: bold;
      color: #f39c12;
      margin-bottom: 10px;
    }

    .shop-buy-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }

    .shop-buy-btn:hover {
      background: #764ba2;
    }

    .shop-buy-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .shop-owned-badge {
      background: #2ecc71;
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: bold;
    }

    .bundle-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
    }

    .bundle-items {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 10px;
      margin: 20px 0;
    }

    .bundle-item-icon {
      font-size: 32px;
      background: rgba(255,255,255,0.2);
      padding: 15px;
      border-radius: 10px;
    }
  </style>
</head>
<body>

  <!-- ========== AUTH SCREEN ========== -->
  <div id="auth-screen">
    <div class="auth-container">
      <h1 class="auth-title">üß† BrainStorm Royale</h1>
      <p class="auth-subtitle">Battle royale meets trivia!</p>

      <div class="auth-tabs">
        <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
        <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
      </div>

      <div id="auth-error" class="error-message"></div>
      <div id="auth-success" class="success-message"></div>

      <form id="login-form" class="auth-form active" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="login-email" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="login-password" required>
        </div>
        <button type="submit" class="auth-button">Login</button>
      </form>

      <form id="signup-form" class="auth-form" onsubmit="handleSignup(event)">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="signup-username" minlength="3" maxlength="20" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="signup-email" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="signup-password" minlength="6" required>
        </div>
        <button type="submit" class="auth-button">Create Account</button>
      </form>

      <button class="guest-button" onclick="playAsGuest()">Continue as Guest</button>
    </div>
  </div>

  <!-- ========== MENU SCREEN ========== -->
  <div id="menu-screen">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="top-bar-left">
        <button class="top-button" onclick="openSettings()">‚öôÔ∏è Settings</button>
        <button class="top-button" onclick="toggleFriends()">
          üë• Friends
          <span id="friend-requests-badge" class="notification-badge">0</span>
        </button>
      </div>
      <div class="top-bar-right">
        <div class="coins-display">üí∞ <span id="coins-header">0</span></div>
        <button class="top-button" onclick="openShop()">üõçÔ∏è Shop</button>
        <button class="top-button" onclick="openBattleTicket()">üé´ Battle Ticket</button>
        <button class="top-button" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- Main Menu -->
    <div class="menu-container">
      <h1 class="game-title">BrainStorm Royale</h1>
      <p class="game-subtitle">‚ö° Battle Royale meets Trivia ‚ö°</p>

      <div id="user-info" class="user-info">
        <h3 id="username-display"></h3>
        <div class="user-stats">
          <div class="stat">
            <div class="stat-value" id="level-display">1</div>
            <div class="stat-label">Level</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="wins-display">0</div>
            <div class="stat-label">Wins</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="coins-display">0</div>
            <div class="stat-label">Coins</div>
          </div>
        </div>
      </div>

      <div class="menu-buttons">
        <button class="menu-button primary-button" onclick="quickPlay()">‚ö° Quick Play</button>
        <button class="menu-button secondary-button" onclick="showJoinGameModal()">Join Private Game</button>
        <button class="menu-button secondary-button" onclick="createGame()">Create Private Game</button>
      </div>
    </div>

    <!-- Friends Sidebar -->
    <div class="friends-sidebar" id="friends-sidebar">
      <div class="friends-header">Friends</div>
      <div class="friends-tabs">
        <button class="friends-tab active" onclick="switchFriendsTab('friends')">Friends</button>
        <button class="friends-tab" onclick="switchFriendsTab('requests')">
          Requests
          <span id="requests-count" style="display:none;"></span>
        </button>
        <button class="friends-tab" onclick="switchFriendsTab('search')">Search</button>
      </div>
      <div class="friends-content">
        <!-- Friends Tab -->
        <div id="friends-tab-content" class="friends-tab-content">
          <div id="friends-list"></div>
        </div>

        <!-- Requests Tab -->
        <div id="requests-tab-content" class="friends-tab-content hidden">
          <div id="friend-requests-list"></div>
        </div>

        <!-- Search Tab -->
        <div id="search-tab-content" class="friends-tab-content hidden">
          <div class="friend-search">
            <input type="text" id="friend-search-input" placeholder="Search username..." onkeyup="searchUsers()">
          </div>
          <div id="search-results"></div>
        </div>
      </div>
    </div>

    <!-- Party Panel -->
    <div class="party-panel" id="party-panel">
      <div class="party-header">
        <span>Party</span>
        <button class="friend-button decline-button" onclick="leaveParty()">Leave</button>
      </div>
      <div id="party-members"></div>
      <button class="menu-button primary-button mt-20" onclick="partyReadyToggle()">Ready Up</button>
    </div>
  </div>

  <!-- ========== BATTLE TICKET MODAL ========== -->
  <div id="battle-ticket-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 800px;">
      <button class="modal-close" onclick="closeBattleTicket()">√ó</button>
      <div class="battle-ticket-header">
        <div class="season-title" id="season-name">Season 1: Brain Storm Rising</div>
        <div class="tier-display">Tier <span id="current-tier">0</span> / <span id="max-tier">50</span></div>
        <div class="xp-progress">
          <div class="xp-bar" id="xp-bar" style="width: 0%"></div>
        </div>
        <div class="text-center"><span id="xp-text">0 / 1000 XP</span></div>
      </div>

      <div id="premium-banner" class="premium-banner" onclick="buyPremium()">
        <h3>üåü Unlock Premium Battle Ticket üåü</h3>
        <p>Get exclusive rewards for only 950 coins!</p>
      </div>

      <div class="reward-tiers" id="reward-tiers-list"></div>
    </div>
  </div>

  <!-- ========== SETTINGS MODAL ========== -->
  <div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
      <button class="modal-close" onclick="closeSettings()">√ó</button>
      <h2 style="margin-bottom: 20px; color: #667eea;">Settings</h2>

      <div class="settings-section">
        <h3>Chat Settings</h3>
        <div class="setting-item">
          <span>Enable Text Chat</span>
          <div class="toggle-switch" id="chat-toggle" onclick="toggleSetting('chat')"></div>
        </div>
        <div class="setting-item">
          <span>Profanity Filter</span>
          <div class="toggle-switch active" id="profanity-toggle" onclick="toggleSetting('profanity')"></div>
        </div>
      </div>

      <div class="settings-section">
        <h3>Voice Chat Settings</h3>
        <div class="warning-box">
          <h4>‚ö†Ô∏è Voice Chat Warning</h4>
          <p>Voice chat connects you directly with other players. By enabling voice chat, you agree to communicate respectfully and not share personal information. Parents should monitor their child's online interactions.</p>
        </div>
        <div class="setting-item">
          <span>Enable Voice Chat</span>
          <div class="toggle-switch" id="voice-toggle" onclick="toggleVoiceChat()"></div>
        </div>
      </div>

      <div class="settings-section">
        <h3>Privacy Settings</h3>
        <div class="setting-item">
          <span>Show Online Status</span>
          <div class="toggle-switch active" id="online-toggle" onclick="toggleSetting('online')"></div>
        </div>
        <div class="setting-item">
          <span>Allow Friend Requests</span>
          <div class="toggle-switch active" id="friend-requests-toggle" onclick="toggleSetting('friendRequests')"></div>
        </div>
      </div>

      <button class="auth-button mt-20" onclick="saveSettings()">Save Settings</button>
    </div>
  </div>

  <!-- ========== SHOP MODAL ========== -->
  <div id="shop-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
      <button class="modal-close" onclick="closeShop()">√ó</button>
      <h2 style="margin-bottom: 20px; color: #667eea;">üõçÔ∏è Item Shop</h2>
      
      <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
        <span style="font-size: 24px; font-weight: bold;">üí∞ Your Coins: <span id="shop-coins-display">0</span></span>
      </div>

      <!-- Shop Tabs -->
      <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd;">
        <button class="shop-tab active" onclick="switchShopTab('skins')" data-tab="skins">üé® Skins</button>
        <button class="shop-tab" onclick="switchShopTab('emotes')" data-tab="emotes">üòä Emotes</button>
        <button class="shop-tab" onclick="switchShopTab('trails')" data-tab="trails">‚ú® Trails</button>
        <button class="shop-tab" onclick="switchShopTab('weapon_skins')" data-tab="weapon_skins">üî´ Weapon Skins</button>
        <button class="shop-tab" onclick="switchShopTab('bundles')" data-tab="bundles">üì¶ Bundles</button>
      </div>

      <!-- Shop Content -->
      <div id="shop-content" style="min-height: 400px;">
        <p style="text-align: center; color: #666;">Loading shop...</p>
      </div>
    </div>
  </div>

  <!-- Simplified Lobby/Game screens for now - keeping your existing ones -->
  <div id="lobby-screen"></div>
  <div id="game-screen">
    <canvas id="game-canvas"></canvas>
    
    <!-- Chat Window (in-game) -->
    <div class="chat-window" id="game-chat">
      <div class="chat-header">Chat (Press Enter)</div>
      <div class="chat-messages" id="chat-messages"></div>
      <div class="chat-input-container">
        <input type="text" class="chat-input" id="chat-input" placeholder="Type a message..." maxlength="200">
      </div>
    </div>

    <!-- Voice Controls (in-game) -->
    <div class="voice-controls" id="voice-controls">
      <div class="mb-10">
        <span class="voice-indicator" id="voice-indicator"></span>
        <span>Voice Chat</span>
      </div>
      <button class="voice-button" id="ptt-button">Hold V to Talk</button>
    </div>
  </div>
  <div id="postgame-screen"></div>

  <script>
    // ========== GLOBAL STATE ==========
    let socket;
    let authToken = null;
    let currentUser = null;
    let currentGameCode = null;
    let isGuest = false;
    let currentSettings = {
      chatEnabled: true,
      voiceChatEnabled: false,
      profanityFilter: true,
      friendRequestsEnabled: true,
      showOnlineStatus: true
    };

    // ========== AUTH FUNCTIONS ==========
    function switchAuthTab(tab) {
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
      
      if (tab === 'login') {
        document.querySelector('.auth-tab').classList.add('active');
        document.getElementById('login-form').classList.add('active');
      } else {
        document.querySelectorAll('.auth-tab')[1].classList.add('active');
        document.getElementById('signup-form').classList.add('active');
      }
      hideMessages();
    }

    async function handleLogin(e) {
      e.preventDefault();
      hideMessages();
      
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      
      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          authToken = data.token;
          currentUser = data.user;
          localStorage.setItem('authToken', authToken);
          connectToGame();
        } else {
          showError(data.error);
        }
      } catch (error) {
        showError('Connection error. Please try again.');
      }
    }

    async function handleSignup(e) {
      e.preventDefault();
      hideMessages();
      
      const username = document.getElementById('signup-username').value;
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      
      try {
        const response = await fetch('/api/auth/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          authToken = data.token;
          currentUser = data.user;
          localStorage.setItem('authToken', authToken);
          showSuccess('Account created! Logging in...');
          setTimeout(() => connectToGame(), 1000);
        } else {
          showError(data.error);
        }
      } catch (error) {
        showError('Connection error. Please try again.');
      }
    }

    function playAsGuest() {
      isGuest = true;
      currentUser = {
        username: 'Guest' + Math.floor(Math.random() * 10000),
        stats: { level: 1, wins: 0, coins: 0 }
      };
      connectToGame();
    }

    function logout() {
      if (authToken) {
        fetch('/api/auth/logout', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
      }
      
      authToken = null;
      currentUser = null;
      isGuest = false;
      localStorage.removeItem('authToken');
      
      if (socket) socket.disconnect();
      
      location.reload();
    }

    function showError(message) {
      const errorDiv = document.getElementById('auth-error');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    function showSuccess(message) {
      const successDiv = document.getElementById('auth-success');
      successDiv.textContent = message;
      successDiv.style.display = 'block';
    }

    function hideMessages() {
      document.getElementById('auth-error').style.display = 'none';
      document.getElementById('auth-success').style.display = 'none';
    }

    // ========== SOCKET CONNECTION ==========
    function connectToGame() {
      socket = io({
        auth: { token: authToken || null }
      });
      
      socket.on('connect', () => {
        console.log('Connected to server');
        showMenuScreen();
        if (!isGuest) {
          loadFriends();
          loadFriendRequests();
          loadBattleTicket();
        }
      });
      
      socket.on('game-created', (data) => {
        console.log('Game created!', data);
        currentGameCode = data.gameCode;
        showLobbyScreen();
      });
      
      socket.on('lobby-update', (data) => {
        console.log('Lobby update:', data);
        updateLobbyPlayers(data.players, data.host);
      });
      
      socket.on('game-joined', (data) => {
        console.log('Joined game!', data);
        currentGameCode = data.gameCode;
        showLobbyScreen();
      });
      
      socket.on('game-started', (data) => {
        console.log('Game starting!', data);
        // Hide lobby, show game screen
        document.getElementById('lobby-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'block';
        // Initialize game canvas and start gameplay
        if (typeof initGame === 'function') {
          initGame(data);
        }
      });
      
      socket.on('error', (data) => {
        alert('‚ùå ' + data.message);
      });
      
      socket.on('user-info', (data) => {
        if (!isGuest && data.username) {
          currentUser.username = data.username;
        }
      });

      // Party events
      socket.on('party-created', (data) => {
        document.getElementById('party-panel').classList.add('active');
      });

      socket.on('party-update', (data) => {
        renderPartyMembers(data.members, data.leader);
      });

      socket.on('party-invite', (data) => {
        if (confirm(`${data.from} invited you to their party. Join?`)) {
          socket.emit('accept-party-invite', { partyId: data.partyId });
          document.getElementById('party-panel').classList.add('active');
        }
      });

      // Chat events
      socket.on('chat-message', (msg) => {
        addChatMessage(msg);
      });
      
      setupGameHandlers();
    }

    function showMenuScreen() {
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('menu-screen').style.display = 'block';
      updateUserDisplay();
    }
    
    function showLobbyScreen() {
      // Hide other screens
      document.getElementById('menu-screen').style.display = 'none';
      document.getElementById('game-screen').style.display = 'none';
      
      // Show lobby
      const lobbyScreen = document.getElementById('lobby-screen');
      lobbyScreen.style.display = 'block';
      
      // Create lobby UI
      lobbyScreen.innerHTML = `
        <div style="padding: 40px; max-width: 800px; margin: 0 auto;">
          <h1 style="color: white; text-align: center; margin-bottom: 20px;">üéÆ Game Lobby</h1>
          <div style="background: rgba(255,255,255,0.95); padding: 30px; border-radius: 20px; margin-bottom: 20px;">
            <h2 style="text-align: center; color: #667eea; margin-bottom: 10px;">Game Code</h2>
            <div style="font-size: 48px; font-weight: bold; text-align: center; color: #764ba2; letter-spacing: 8px;">
              ${currentGameCode || 'LOADING...'}
            </div>
            <p style="text-align: center; color: #666; margin-top: 10px;">Share this code with friends!</p>
          </div>
          
          <div style="background: rgba(255,255,255,0.95); padding: 30px; border-radius: 20px; margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 15px;">Players in Lobby</h3>
            <div id="lobby-players-list" style="min-height: 100px;">
              <p style="color: #666; text-align: center;">Waiting for players...</p>
            </div>
          </div>
          
          <div style="text-align: center;">
            <button id="ready-toggle-btn" style="background: #95a5a6; color: white; border: none; padding: 15px 40px; font-size: 18px; border-radius: 10px; cursor: pointer; margin-right: 10px;">
              ‚è≥ Ready Up
            </button>
            <button id="start-game-btn" style="display: none; background: #2ecc71; color: white; border: none; padding: 15px 40px; font-size: 18px; border-radius: 10px; cursor: pointer; margin-right: 10px;">
              üöÄ Start Game
            </button>
            <button id="leave-lobby-btn" style="background: #e74c3c; color: white; border: none; padding: 15px 40px; font-size: 18px; border-radius: 10px; cursor: pointer;">
              üö™ Leave Lobby
            </button>
          </div>
          
          <div id="lobby-status" style="margin-top: 20px; text-align: center; color: white; font-size: 16px;">
            <!-- Status messages will appear here -->
          </div>
        </div>
      `;
      
      // Add event listeners
      const readyBtn = document.getElementById('ready-toggle-btn');
      const startBtn = document.getElementById('start-game-btn');
      const leaveBtn = document.getElementById('leave-lobby-btn');
      
      if (readyBtn) {
        readyBtn.addEventListener('click', () => {
          socket.emit('toggle-ready');
        });
      }
      
      if (startBtn) {
        startBtn.addEventListener('click', () => {
          socket.emit('start-game');
        });
      }
      
      if (leaveBtn) {
        leaveBtn.addEventListener('click', () => {
          socket.emit('leave-game');
          showMenuScreen();
          lobbyScreen.style.display = 'none';
        });
      }
    }

    function updateLobbyPlayers(players, hostId) {
      const playersList = document.getElementById('lobby-players-list');
      if (!playersList) return;
      
      // Count ready players
      const readyCount = players.filter(p => p.isReady).length;
      const totalCount = players.length;
      const allReady = readyCount === totalCount;
      
      playersList.innerHTML = players.map(player => `
        <div style="padding: 15px; background: ${player.id === hostId ? '#ffeaa7' : '#f5f5f5'}; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <strong style="font-size: 18px;">${player.username}</strong>
            ${player.id === hostId ? '<span style="color: #fdcb6e; margin-left: 10px;">üëë Host</span>' : ''}
          </div>
          <div style="color: ${player.isReady ? '#2ecc71' : '#95a5a6'}; font-weight: bold;">
            ${player.isReady ? '‚úÖ Ready' : '‚è≥ Not Ready'}
          </div>
        </div>
      `).join('');
      
      // Update ready button for current player
      const currentPlayer = players.find(p => p.id === socket.id);
      const readyBtn = document.getElementById('ready-toggle-btn');
      if (readyBtn && currentPlayer) {
        if (currentPlayer.isReady) {
          readyBtn.style.background = '#2ecc71';
          readyBtn.textContent = '‚úÖ Ready!';
        } else {
          readyBtn.style.background = '#95a5a6';
          readyBtn.textContent = '‚è≥ Ready Up';
        }
      }
      
      // Show start button only if you're the host
      const startBtn = document.getElementById('start-game-btn');
      if (startBtn && socket.id === hostId) {
        startBtn.style.display = 'inline-block';
        
        // Enable/disable based on all ready
        if (allReady) {
          startBtn.disabled = false;
          startBtn.style.opacity = '1';
          startBtn.style.cursor = 'pointer';
        } else {
          startBtn.disabled = true;
          startBtn.style.opacity = '0.5';
          startBtn.style.cursor = 'not-allowed';
        }
      }
      
      // Update status message
      const statusDiv = document.getElementById('lobby-status');
      if (statusDiv) {
        if (socket.id === hostId) {
          if (allReady) {
            statusDiv.innerHTML = '<span style="color: #2ecc71; font-weight: bold;">‚úÖ All players ready! Click Start Game!</span>';
          } else {
            statusDiv.innerHTML = `<span style="color: #f39c12;">‚è≥ Waiting for players... (${readyCount}/${totalCount} ready)</span>`;
          }
        } else {
          if (currentPlayer && currentPlayer.isReady) {
            statusDiv.innerHTML = '<span style="color: #2ecc71;">‚úÖ You are ready! Waiting for host to start...</span>';
          } else {
            statusDiv.innerHTML = '<span style="color: #f39c12;">‚è≥ Click "Ready Up" when you\'re ready to play!</span>';
          }
        }
      }
    }

    function updateUserDisplay() {
      document.getElementById('username-display').textContent = 
        currentUser.username + (isGuest ? ' (Guest)' : '');
      document.getElementById('level-display').textContent = currentUser.stats.level;
      document.getElementById('wins-display').textContent = currentUser.stats.wins;
      document.getElementById('coins-display').textContent = currentUser.stats.coins;
      document.getElementById('coins-header').textContent = currentUser.stats.coins;
      
      if (isGuest) {
        document.getElementById('user-info').style.borderColor = '#ff9900';
      }
    }

    // ========== FRIENDS SYSTEM ==========
    function toggleFriends() {
      document.getElementById('friends-sidebar').classList.toggle('open');
    }

    function switchFriendsTab(tab) {
      document.querySelectorAll('.friends-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.friends-tab-content').forEach(c => c.classList.add('hidden'));
      
      event.target.classList.add('active');
      
      if (tab === 'friends') {
        document.getElementById('friends-tab-content').classList.remove('hidden');
      } else if (tab === 'requests') {
        document.getElementById('requests-tab-content').classList.remove('hidden');
      } else if (tab === 'search') {
        document.getElementById('search-tab-content').classList.remove('hidden');
      }
    }

    async function loadFriends() {
      try {
        const res = await fetch('/api/friends/list', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const friends = await res.json();
        renderFriendsList(friends);
      } catch (error) {
        console.error('Load friends error:', error);
      }
    }

    function renderFriendsList(friends) {
      const listEl = document.getElementById('friends-list');
      listEl.innerHTML = '';
      
      if (friends.length === 0) {
        listEl.innerHTML = '<p style="text-align:center;color:#999;">No friends yet</p>';
        return;
      }
      
      friends.forEach(friend => {
        const item = document.createElement('div');
        item.className = 'friend-item';
        item.innerHTML = `
          <div class="friend-info">
            <div class="friend-name">
              <span class="${friend.isOnline ? 'online' : 'offline'}-indicator"></span>
              ${friend.username}
            </div>
            <div class="friend-status">
              Level ${friend.level} ${friend.inGame ? '‚Ä¢ In Game' : ''}
            </div>
          </div>
          <div class="friend-actions">
            <button class="friend-button invite-button" onclick="inviteToParty('${friend.id}')">Invite</button>
          </div>
        `;
        listEl.appendChild(item);
      });
    }

    async function loadFriendRequests() {
      try {
        const res = await fetch('/api/friends/requests', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const requests = await res.json();
        renderFriendRequests(requests);
        
        const badge = document.getElementById('friend-requests-badge');
        if (requests.length > 0) {
          badge.textContent = requests.length;
          badge.classList.add('active');
          document.getElementById('requests-count').textContent = ` (${requests.length})`;
          document.getElementById('requests-count').style.display = 'inline';
        }
      } catch (error) {
        console.error('Load requests error:', error);
      }
    }

    function renderFriendRequests(requests) {
      const listEl = document.getElementById('friend-requests-list');
      listEl.innerHTML = '';
      
      if (requests.length === 0) {
        listEl.innerHTML = '<p style="text-align:center;color:#999;">No pending requests</p>';
        return;
      }
      
      requests.forEach(req => {
        const item = document.createElement('div');
        item.className = 'friend-item';
        item.innerHTML = `
          <div class="friend-info">
            <div class="friend-name">${req.from.username}</div>
            <div class="friend-status">Level ${req.from.level}</div>
          </div>
          <div class="friend-actions">
            <button class="friend-button accept-button" onclick="acceptFriendRequest('${req.id}')">‚úì</button>
            <button class="friend-button decline-button" onclick="declineFriendRequest('${req.id}')">‚úó</button>
          </div>
        `;
        listEl.appendChild(item);
      });
    }

    async function acceptFriendRequest(requestId) {
      try {
        await fetch('/api/friends/accept', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ requestId })
        });
        loadFriends();
        loadFriendRequests();
      } catch (error) {
        console.error('Accept error:', error);
      }
    }

    async function declineFriendRequest(requestId) {
      try {
        await fetch('/api/friends/decline', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ requestId })
        });
        loadFriendRequests();
      } catch (error) {
        console.error('Decline error:', error);
      }
    }

    let searchTimeout;
    async function searchUsers() {
      clearTimeout(searchTimeout);
      const query = document.getElementById('friend-search-input').value;
      
      if (query.length < 2) {
        document.getElementById('search-results').innerHTML = '';
        return;
      }
      
      searchTimeout = setTimeout(async () => {
        try {
          const res = await fetch(`/api/friends/search?query=${encodeURIComponent(query)}`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
          });
          const results = await res.json();
          renderSearchResults(results);
        } catch (error) {
          console.error('Search error:', error);
        }
      }, 300);
    }

    function renderSearchResults(results) {
      const listEl = document.getElementById('search-results');
      listEl.innerHTML = '';
      
      if (results.length === 0) {
        listEl.innerHTML = '<p style="text-align:center;color:#999;">No users found</p>';
        return;
      }
      
      results.forEach(user => {
        const item = document.createElement('div');
        item.className = 'friend-item';
        
        let actionButton = '';
        if (user.isFriend) {
          actionButton = '<span style="color: #44ff44;">‚úì Friends</span>';
        } else if (user.isBlocked) {
          actionButton = '<span style="color: #ff4444;">Blocked</span>';
        } else {
          actionButton = `<button class="friend-button invite-button" onclick="sendFriendRequest('${user.username}')">Add Friend</button>`;
        }
        
        item.innerHTML = `
          <div class="friend-info">
            <div class="friend-name">${user.username}</div>
            <div class="friend-status">Level ${user.level}</div>
          </div>
          <div class="friend-actions">${actionButton}</div>
        `;
        listEl.appendChild(item);
      });
    }

    async function sendFriendRequest(username) {
      try {
        const res = await fetch('/api/friends/request', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username })
        });
        const data = await res.json();
        
        if (res.ok) {
          alert('Friend request sent!');
          searchUsers(); // Refresh search results
        } else {
          alert(data.error);
        }
      } catch (error) {
        console.error('Send request error:', error);
      }
    }

    // ========== PARTY SYSTEM ==========
    function createParty() {
      if (isGuest) {
        alert('Guests cannot create parties');
        return;
      }
      socket.emit('create-party');
    }

    function inviteToParty(userId) {
      socket.emit('invite-to-party', { userId });
      alert('Invite sent!');
    }

    function leaveParty() {
      socket.emit('leave-party');
      document.getElementById('party-panel').classList.remove('active');
    }

    function partyReadyToggle() {
      socket.emit('party-ready-toggle');
    }

    function renderPartyMembers(members, leaderId) {
      const container = document.getElementById('party-members');
      container.innerHTML = '';
      
      members.forEach(member => {
        const div = document.createElement('div');
        div.className = 'party-member';
        if (member.ready) div.classList.add('ready');
        if (member.userId === leaderId) div.classList.add('leader');
        
        div.innerHTML = `
          <span>${member.username} ${member.userId === leaderId ? 'üëë' : ''}</span>
          <span>${member.ready ? '‚úì Ready' : '‚è≥'}</span>
        `;
        container.appendChild(div);
      });
    }

    // ========== BATTLE TICKET ==========
    async function loadBattleTicket() {
      try {
        const res = await fetch('/api/battle-ticket/status', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const data = await res.json();
        renderBattleTicketStatus(data);
      } catch (error) {
        console.error('Load battle ticket error:', error);
      }
    }

    function renderBattleTicketStatus(data) {
      document.getElementById('season-name').textContent = `Season ${data.season}: ${data.seasonName}`;
      document.getElementById('current-tier').textContent = data.currentTier;
      document.getElementById('max-tier').textContent = data.maxTier;
      
      const progress = (data.xpProgress / data.xpNeeded) * 100;
      document.getElementById('xp-bar').style.width = progress + '%';
      document.getElementById('xp-text').textContent = `${data.xpProgress} / ${data.xpNeeded} XP`;
      
      if (data.hasPremium) {
        document.getElementById('premium-banner').style.display = 'none';
      }
    }

    async function openBattleTicket() {
      if (isGuest) {
        alert('Battle Ticket is only available for registered users');
        return;
      }
      
      await loadBattleTicket();
      await loadBattleTicketRewards();
      document.getElementById('battle-ticket-modal').classList.add('active');
    }

    function closeBattleTicket() {
      document.getElementById('battle-ticket-modal').classList.remove('active');
    }

    async function loadBattleTicketRewards() {
      try {
        const res = await fetch('/api/battle-ticket/rewards', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const rewards = await res.json();
        renderRewardTiers(rewards);
      } catch (error) {
        console.error('Load rewards error:', error);
      }
    }

    function renderRewardTiers(tiers) {
      const container = document.getElementById('reward-tiers-list');
      container.innerHTML = '';
      
      tiers.forEach(tier => {
        const div = document.createElement('div');
        div.className = 'reward-tier';
        if (tier.locked) div.classList.add('locked');
        if (tier.claimed) div.classList.add('claimed');
        
        let rewardsHtml = '';
        [...tier.free, ...tier.premium].forEach(reward => {
          const isPremium = tier.premium.includes(reward);
          rewardsHtml += `<div class="reward-item ${isPremium ? 'premium' : ''}">
            ${getRewardDisplay(reward)}
          </div>`;
        });
        
        div.innerHTML = `
          <div class="tier-number">Tier ${tier.tier}</div>
          <div class="tier-rewards">${rewardsHtml}</div>
          ${!tier.locked && !tier.claimed ? `<button class="claim-button" onclick="claimReward(${tier.tier})">Claim Rewards</button>` : ''}
          ${tier.claimed ? '<div style="text-align:center;color:#44ff44;font-weight:bold;margin-top:10px;">‚úì Claimed</div>' : ''}
          ${tier.locked ? '<div style="text-align:center;color:#999;margin-top:10px;">üîí Locked</div>' : ''}
        `;
        
        container.appendChild(div);
      });
    }

    function getRewardDisplay(reward) {
      if (reward.type === 'coins') return `üí∞ ${reward.amount} Coins`;
      if (reward.type === 'xp_boost') return `‚ö° ${reward.amount} XP`;
      if (reward.type === 'skin') return `üë§ ${reward.id}`;
      if (reward.type === 'emote') return `üòä ${reward.id}`;
      if (reward.type === 'trail') return `‚ú® ${reward.id}`;
      return reward.type;
    }

    async function claimReward(tier) {
      try {
        const res = await fetch(`/api/battle-ticket/claim/${tier}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const data = await res.json();
        
        if (res.ok) {
          alert('Rewards claimed! ' + data.items.map(i => getRewardDisplay(i)).join(', '));
          currentUser.stats.coins = data.coins;
          updateUserDisplay();
          loadBattleTicket();
          loadBattleTicketRewards();
        } else {
          alert(data.error);
        }
      } catch (error) {
        console.error('Claim error:', error);
      }
    }

    async function buyPremium() {
      if (confirm('Purchase Premium Battle Ticket for 950 coins?')) {
        try {
          const res = await fetch('/api/battle-ticket/buy-premium', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${authToken}` }
          });
          const data = await res.json();
          
          if (res.ok) {
            alert('Premium Battle Ticket purchased!');
            currentUser.stats.coins = data.coins;
            updateUserDisplay();
            loadBattleTicket();
          } else {
            alert(data.error);
          }
        } catch (error) {
          console.error('Buy premium error:', error);
        }
      }
    }

    // ========== CHAT SYSTEM ==========
    function addChatMessage(msg) {
      const container = document.getElementById('chat-messages');
      const div = document.createElement('div');
      div.className = 'chat-message';
      div.innerHTML = `<span class="chat-username">${msg.username}:</span> ${msg.message}`;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    // Chat input handling
    document.addEventListener('DOMContentLoaded', () => {
      const chatInput = document.getElementById('chat-input');
      if (chatInput) {
        chatInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && chatInput.value.trim()) {
            socket.emit('send-chat-message', { message: chatInput.value });
            chatInput.value = '';
          }
        });
      }
    });

    // ========== SETTINGS ==========
    function openSettings() {
      document.getElementById('settings-modal').classList.add('active');
      loadUserSettings();
    }

    function closeSettings() {
      document.getElementById('settings-modal').classList.remove('active');
    }

    async function loadUserSettings() {
      if (isGuest) return;
      
      try {
        const res = await fetch('/api/auth/profile', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const data = await res.json();
        
        if (data.settings) {
          currentSettings = data.settings;
          updateSettingsUI();
        }
      } catch (error) {
        console.error('Load settings error:', error);
      }
    }

    function updateSettingsUI() {
      document.getElementById('chat-toggle').classList.toggle('active', currentSettings.chatEnabled);
      document.getElementById('profanity-toggle').classList.toggle('active', currentSettings.profanityFilter);
      document.getElementById('voice-toggle').classList.toggle('active', currentSettings.voiceChatEnabled);
      document.getElementById('online-toggle').classList.toggle('active', currentSettings.showOnlineStatus);
      document.getElementById('friend-requests-toggle').classList.toggle('active', currentSettings.friendRequestsEnabled);
    }

    function toggleSetting(setting) {
      const toggle = event.currentTarget;
      toggle.classList.toggle('active');
      
      if (setting === 'chat') currentSettings.chatEnabled = toggle.classList.contains('active');
      if (setting === 'profanity') currentSettings.profanityFilter = toggle.classList.contains('active');
      if (setting === 'online') currentSettings.showOnlineStatus = toggle.classList.contains('active');
      if (setting === 'friendRequests') currentSettings.friendRequestsEnabled = toggle.classList.contains('active');
    }

    function toggleVoiceChat() {
      const toggle = event.currentTarget;
      if (!toggle.classList.contains('active')) {
        if (confirm('Enable voice chat? This will allow you to communicate with other players.')) {
          toggle.classList.add('active');
          currentSettings.voiceChatEnabled = true;
        }
      } else {
        toggle.classList.remove('active');
        currentSettings.voiceChatEnabled = false;
      }
    }

    async function saveSettings() {
      if (isGuest) {
        alert('Guests cannot save settings');
        return;
      }
      
      try {
        const res = await fetch('/api/auth/profile', {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ settings: currentSettings })
        });
        
        if (res.ok) {
          alert('Settings saved!');
          closeSettings();
        }
      } catch (error) {
        console.error('Save settings error:', error);
      }
    }

    // ========== GAME FUNCTIONS (simplified for now) ==========
    function setupGameHandlers() {
      // Add your existing game handlers here
    }

    function quickPlay() {
      alert('Quick Play coming soon!');
    }

    function showJoinGameModal() {
      const code = prompt('Enter game code:');
      if (code) {
        socket.emit('join-game', {
          gameCode: code,
          username: currentUser.username,
          skin: currentUser.inventory?.equippedSkin || 'default'
        });
      }
    }

    // ========== SHOP FUNCTIONS ==========
    let currentShopTab = 'skins';
    
    async function openShop() {
      document.getElementById('shop-modal').classList.add('active');
      document.getElementById('shop-coins-display').textContent = currentUser.stats.coins;
      await loadShopItems('skins');
    }
    
    function closeShop() {
      document.getElementById('shop-modal').classList.remove('active');
    }
    
    async function switchShopTab(tab) {
      // Update active tab
      document.querySelectorAll('.shop-tab').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
      
      currentShopTab = tab;
      await loadShopItems(tab);
    }
    
    async function loadShopItems(category) {
      const content = document.getElementById('shop-content');
      content.innerHTML = '<p style="text-align: center;">Loading...</p>';
      
      try {
        let items = [];
        
        if (category === 'bundles') {
          const res = await fetch('/api/shop/bundles', {
            headers: { 'Authorization': `Bearer ${authToken}` }
          });
          const data = await res.json();
          content.innerHTML = renderBundles(data);
          return;
        } else {
          // Load all items and filter by category
          const res = await fetch('/api/shop/items', {
            headers: { 'Authorization': `Bearer ${authToken}` }
          });
          const allItems = await res.json();
          
          // Map category names to item types
          const typeMap = {
            'skins': 'skin',
            'emotes': 'emote',
            'trails': 'trail',
            'weapon_skins': 'weapon_skin'
          };
          
          const itemType = typeMap[category];
          items = allItems.filter(item => item.type === itemType);
          
          console.log(`Category: ${category}, Type: ${itemType}, Items found:`, items.length);
        }
        
        content.innerHTML = renderShopItems(items, category);
      } catch (error) {
        console.error('Load shop error:', error);
        content.innerHTML = '<p style="text-align: center; color: red;">Error loading shop</p>';
      }
    }
    
    function renderShopItems(items, category) {
      if (items.length === 0) {
        return '<p style="text-align: center; color: #666;">No items available in this category</p>';
      }
      
      return `
        <div class="shop-grid">
          ${items.map(item => `
            <div class="shop-item ${item.owned ? 'owned' : ''}">
              <div class="shop-item-icon">${getItemIcon(item.type, item)}</div>
              <div class="shop-item-name">${item.name}</div>
              <div class="shop-item-rarity rarity-${item.rarity || 'common'}">${(item.rarity || 'common').toUpperCase()}</div>
              <div class="shop-item-price">üí∞ ${item.price}</div>
              ${item.owned 
                ? '<div class="shop-owned-badge">‚úÖ Owned</div>'
                : `<button class="shop-buy-btn" onclick="buyItem('${item.id}', '${item.type}', ${item.price})">Buy Now</button>`
              }
            </div>
          `).join('')}
        </div>
      `;
    }
    
    function renderBundles(bundles) {
      if (!bundles || bundles.length === 0) {
        return '<p style="text-align: center; color: #666;">No bundles available</p>';
      }
      
      return bundles.map(bundle => `
        <div class="bundle-card">
          <h3 style="margin-bottom: 10px;">${bundle.name}</h3>
          <p style="opacity: 0.9; margin-bottom: 15px;">${bundle.description || ''}</p>
          
          <div class="bundle-items">
            ${bundle.items.map(item => `
              <div class="bundle-item-icon" title="${item.name}">${getItemIcon(item.type)}</div>
            `).join('')}
          </div>
          
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
            <div>
              <span style="font-size: 24px; font-weight: bold;">üí∞ ${bundle.price}</span>
              ${bundle.originalPrice ? `<span style="text-decoration: line-through; opacity: 0.7; margin-left: 10px;">${bundle.originalPrice}</span>` : ''}
              ${bundle.discount ? `<span style="background: #e74c3c; padding: 4px 8px; border-radius: 5px; margin-left: 10px; font-size: 14px;">${bundle.discount}% OFF</span>` : ''}
            </div>
            ${bundle.allOwned 
              ? '<span style="background: #2ecc71; padding: 10px 20px; border-radius: 10px;">‚úÖ All Owned</span>'
              : `<button class="shop-buy-btn" style="padding: 15px 30px; font-size: 16px;" onclick="buyBundle('${bundle.id}', ${bundle.price})">Buy Bundle</button>`
            }
          </div>
        </div>
      `).join('');
    }
    
    function getItemIcon(type, item) {
      const icons = {
        skin: 'ü§ñ',
        emote: 'üòä',
        trail: '‚ú®',
        weapon_skin: 'üî´'
      };
      
      // For weapon skins, could show specific weapon icons
      if (type === 'weapon_skin' && item && item.weapon) {
        const weaponIcons = {
          pistol: 'üî´',
          rifle: 'üéØ',
          shotgun: 'üí•',
          sniper: 'üéØ',
          smg: '‚ö°',
          rocket_launcher: 'üöÄ'
        };
        return weaponIcons[item.weapon] || 'üî´';
      }
      
      return icons[type] || 'üéÅ';
    }
    
    async function buyItem(itemId, itemType, price) {
      if (currentUser.stats.coins < price) {
        alert('‚ùå Not enough coins!');
        return;
      }
      
      if (!confirm(`Buy this item for ${price} coins?`)) {
        return;
      }
      
      try {
        const res = await fetch('/api/shop/purchase', {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ itemId, itemType })
        });
        
        const data = await res.json();
        
        if (res.ok) {
          alert('‚úÖ Purchase successful!');
          currentUser.stats.coins = data.newBalance;
          document.getElementById('shop-coins-display').textContent = data.newBalance;
          document.getElementById('coins-header').textContent = data.newBalance;
          document.getElementById('coins-display').textContent = data.newBalance;
          await loadShopItems(currentShopTab);
        } else {
          alert('‚ùå ' + (data.error || 'Purchase failed'));
        }
      } catch (error) {
        console.error('Purchase error:', error);
        alert('‚ùå Error purchasing item');
      }
    }
    
    async function buyBundle(bundleId, price) {
      if (currentUser.stats.coins < price) {
        alert('‚ùå Not enough coins!');
        return;
      }
      
      if (!confirm(`Buy this bundle for ${price} coins?`)) {
        return;
      }
      
      try {
        const res = await fetch('/api/shop/purchase-bundle', {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ bundleId })
        });
        
        const data = await res.json();
        
        if (res.ok) {
          alert('‚úÖ Bundle purchased!');
          currentUser.stats.coins = data.newBalance;
          document.getElementById('shop-coins-display').textContent = data.newBalance;
          document.getElementById('coins-header').textContent = data.newBalance;
          document.getElementById('coins-display').textContent = data.newBalance;
          await loadShopItems('bundles');
        } else {
          alert('‚ùå ' + (data.error || 'Purchase failed'));
        }
      } catch (error) {
        console.error('Bundle purchase error:', error);
        alert('‚ùå Error purchasing bundle');
      }
    }

    function createGame() {
      socket.emit('create-game', {
        username: currentUser.username,
        skin: currentUser.inventory?.equippedSkin || 'default'
      });
    }

    // Auto-login if token exists
    window.addEventListener('load', () => {
      const savedToken = localStorage.getItem('authToken');
      if (savedToken) {
        authToken = savedToken;
        fetch('/api/auth/profile', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        })
        .then(res => res.json())
        .then(data => {
          if (data.id) {
            currentUser = data;
            connectToGame();
          } else {
            localStorage.removeItem('authToken');
          }
        })
        .catch(() => {
          localStorage.removeItem('authToken');
        });
      }
    });
  </script>

</body>
</html>
