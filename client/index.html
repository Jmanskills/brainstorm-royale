<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <title>Pixelio</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="pixelio-3d-v2.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Arial', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      overflow: hidden;
      height: 100vh;
    }

    /* ========== MODAL SYSTEM ========== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: #ff4444;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-size: 20px;
      line-height: 30px;
    }

    .modal-close:hover {
      background: #cc0000;
    }

    /* ========== AUTH SCREEN ========== */
    #auth-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100vw;
    }

    .auth-container {
      background: rgba(255, 255, 255, 0.95);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 90%;
    }

    .auth-title {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
      text-align: center;
      margin-bottom: 10px;
    }

    .auth-subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
    }

    .auth-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
    }

    .auth-tab {
      flex: 1;
      padding: 12px;
      border: none;
      background: #f0f0f0;
      cursor: pointer;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s;
    }

    .auth-tab.active {
      background: #667eea;
      color: white;
    }

    .auth-form {
      display: none;
    }

    .auth-form.active {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      transition: border 0.3s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .auth-button {
      width: 100%;
      padding: 15px;
      border: none;
      background: #667eea;
      color: white;
      font-size: 16px;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .auth-button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .guest-button {
      width: 100%;
      padding: 15px;
      border: 2px solid #667eea;
      background: white;
      color: #667eea;
      font-size: 16px;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.3s;
    }

    .guest-button:hover {
      background: #f8f8ff;
    }
    
    .google-signin-btn {
      width: 100%;
      padding: 12px 24px;
      background: white;
      color: #444;
      border: 1px solid #ddd;
      font-size: 16px;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .google-signin-btn:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      border-color: #4285f4;
    }
    
    .auth-divider {
      text-align: center;
      margin: 20px 0;
      color: #999;
      font-size: 14px;
    }

    .error-message {
      background: #ff4444;
      color: white;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
    }

    .success-message {
      background: #44ff44;
      color: white;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
    }

    /* ========== MENU SCREEN ========== */
    #menu-screen {
      display: none;
      height: 100vh;
      width: 100vw;
      position: relative;
    }

    .top-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      z-index: 100;
    }

    .top-bar-left {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .top-bar-right {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .top-button {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .top-button:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .coins-display {
      background: rgba(255, 215, 0, 0.3);
      border: 2px solid gold;
      padding: 8px 16px;
      border-radius: 8px;
      color: gold;
      font-weight: bold;
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff4444;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .notification-badge.active {
      display: flex;
    }

    .menu-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 500px;
      width: 90%;
      text-align: center;
    }

    .game-title {
      font-size: 48px;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }

    .game-subtitle {
      color: #666;
      font-size: 18px;
      margin-bottom: 30px;
    }

    .user-info {
      background: #f8f8ff;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 30px;
      border: 2px solid #667eea;
    }

    .user-stats {
      display: flex;
      justify-content: space-around;
      margin-top: 10px;
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
    }
    
    /* ========== SKIN SELECTOR ========== */
    .skin-selector {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .skin-selector h3 {
      color: white;
      text-align: center;
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    .skin-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 10px;
      max-height: 220px;
      overflow-y: auto;
      padding: 5px;
    }
    
    .skin-card {
      background: rgba(255, 255, 255, 0.2);
      border: 3px solid transparent;
      border-radius: 10px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }
    
    .skin-card:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }
    
    .skin-card.selected {
      border-color: #00ff00;
      background: rgba(0, 255, 0, 0.2);
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
    }
    
    .skin-card.locked {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .skin-card.locked:hover {
      transform: none;
      background: rgba(255, 255, 255, 0.2);
    }
    
    .skin-preview {
      width: 60px;
      height: 60px;
      margin: 0 auto;
    }
    
    .skin-name {
      color: white;
      font-size: 11px;
      margin-top: 5px;
      font-weight: bold;
    }

    .menu-buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .menu-button {
      padding: 18px;
      border: none;
      border-radius: 15px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .primary-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
    }

    .primary-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 30px rgba(102, 126, 234, 0.4);
    }

    .secondary-button {
      background: white;
      color: #667eea;
      border: 3px solid #667eea;
    }

    .secondary-button:hover {
      background: #f8f8ff;
      transform: translateY(-2px);
    }

    /* ========== FRIENDS SIDEBAR ========== */
    .friends-sidebar {
      position: absolute;
      right: 0;
      top: 60px;
      bottom: 0;
      width: 300px;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: -5px 0 20px rgba(0,0,0,0.2);
      transform: translateX(100%);
      transition: transform 0.3s;
      z-index: 50;
      overflow-y: auto;
    }

    .friends-sidebar.open {
      transform: translateX(0);
    }

    .friends-header {
      padding: 20px;
      background: #667eea;
      color: white;
      font-size: 20px;
      font-weight: bold;
    }

    .friends-tabs {
      display: flex;
      background: #f0f0f0;
    }

    .friends-tab {
      flex: 1;
      padding: 12px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }

    .friends-tab.active {
      background: white;
      color: #667eea;
    }

    .friends-content {
      padding: 15px;
    }

    .friend-search {
      margin-bottom: 15px;
    }

    .friend-search input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
    }

    .friend-item {
      background: #f8f8ff;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .friend-info {
      flex: 1;
    }

    .friend-name {
      font-weight: bold;
      color: #333;
    }

    .friend-status {
      font-size: 12px;
      color: #666;
    }

    .online-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #44ff44;
      display: inline-block;
      margin-right: 5px;
    }

    .offline-indicator {
      background: #999;
    }

    .friend-actions {
      display: flex;
      gap: 5px;
    }

    .friend-button {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
    }

    .invite-button {
      background: #667eea;
      color: white;
    }

    .accept-button {
      background: #44ff44;
      color: white;
    }

    .decline-button {
      background: #ff4444;
      color: white;
    }

    /* ========== PARTY PANEL ========== */
    .party-panel {
      position: absolute;
      left: 20px;
      bottom: 20px;
      width: 250px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      display: none;
    }

    .party-panel.active {
      display: block;
    }

    .party-header {
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .party-member {
      background: #f8f8ff;
      padding: 8px;
      border-radius: 6px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .party-member.ready {
      border: 2px solid #44ff44;
    }

    .party-member.leader {
      border: 2px solid gold;
    }

    /* ========== BATTLE TICKET MODAL ========== */
    .battle-ticket-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .season-title {
      font-size: 28px;
      font-weight: bold;
      color: #667eea;
    }

    .tier-display {
      font-size: 48px;
      font-weight: bold;
      color: #764ba2;
      margin: 10px 0;
    }

    .xp-progress {
      background: #e0e0e0;
      height: 20px;
      border-radius: 10px;
      overflow: hidden;
      margin: 15px 0;
    }

    .xp-bar {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      height: 100%;
      transition: width 0.3s;
    }

    .premium-banner {
      background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
      color: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      margin: 20px 0;
      cursor: pointer;
    }

    .reward-tiers {
      max-height: 400px;
      overflow-y: auto;
    }

    .reward-tier {
      background: #f8f8ff;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      border: 2px solid #e0e0e0;
    }

    .reward-tier.locked {
      opacity: 0.5;
    }

    .reward-tier.claimed {
      background: #e0e0e0;
    }

    .tier-number {
      font-weight: bold;
      color: #667eea;
      font-size: 18px;
    }

    .tier-rewards {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .reward-item {
      background: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      border: 2px solid #667eea;
    }

    .reward-item.premium {
      border-color: gold;
      background: #fff9e6;
    }

    .claim-button {
      margin-top: 10px;
      padding: 10px 20px;
      background: #44ff44;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }

    /* ========== CHAT WINDOW ========== */
    .chat-window {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 350px;
      height: 300px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 10px;
      display: none;
      flex-direction: column;
    }

    .chat-window.active {
      display: flex;
    }

    .chat-header {
      padding: 10px;
      background: rgba(102, 126, 234, 0.5);
      border-radius: 10px 10px 0 0;
      color: white;
      font-weight: bold;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      color: white;
    }

    .chat-message {
      margin-bottom: 8px;
      padding: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    .chat-username {
      font-weight: bold;
      color: #667eea;
    }

    .chat-input-container {
      padding: 10px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 0 0 10px 10px;
    }

    .chat-input {
      width: 100%;
      padding: 8px;
      border: none;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.9);
    }

    /* ========== VOICE CHAT CONTROLS ========== */
    .voice-controls {
      position: absolute;
      top: 70px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px;
      border-radius: 10px;
      color: white;
      display: none;
    }

    .voice-controls.active {
      display: block;
    }

    .voice-button {
      padding: 10px 20px;
      border: 2px solid white;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
      transition: all 0.3s;
    }

    .voice-button.active {
      background: #44ff44;
      border-color: #44ff44;
      color: black;
    }

    .voice-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #ff4444;
      margin-right: 8px;
    }

    .voice-indicator.speaking {
      background: #44ff44;
      animation: pulse 0.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* ========== SETTINGS MODAL ========== */
    .settings-section {
      margin-bottom: 25px;
    }

    .settings-section h3 {
      color: #667eea;
      margin-bottom: 15px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 5px;
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f8f8ff;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
      background: #ccc;
      border-radius: 13px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch.active {
      background: #667eea;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 22px;
      height: 22px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: left 0.3s;
    }

    .toggle-switch.active::after {
      left: 26px;
    }

    .warning-box {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }

    .warning-box h4 {
      color: #856404;
      margin-bottom: 10px;
    }

    .warning-box p {
      color: #856404;
      font-size: 14px;
    }
    
    /* ========== SETTINGS TABS ========== */
    .settings-tabs {
      display: flex;
      gap: 5px;
      border-bottom: 2px solid #ddd;
      margin-bottom: 0;
      overflow-x: auto;
    }
    
    .settings-tab {
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      padding: 12px 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #666;
      transition: all 0.3s;
      white-space: nowrap;
    }
    
    .settings-tab:hover {
      color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }
    
    .settings-tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    
    .settings-panel {
      display: none;
    }
    
    .settings-panel.active {
      display: block;
    }
    
    .setting-description {
      font-size: 12px;
      color: #666;
      margin: -5px 0 15px 0;
      font-style: italic;
    }
    
    .settings-select {
      padding: 8px 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
      font-size: 14px;
      cursor: pointer;
      min-width: 180px;
    }
    
    .settings-select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    /* ========== KEYBIND STYLES ========== */
    .keybind-list {
      background: white;
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
    }
    
    .keybind-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .keybind-item:last-child {
      border-bottom: none;
    }
    
    .keybind-button {
      background: #667eea;
      color: white;
      border: none;
      padding: 6px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      min-width: 60px;
      text-align: center;
      transition: all 0.3s;
    }
    
    .keybind-button:hover {
      background: #5568d3;
      transform: scale(1.05);
    }
    
    .keybind-button.waiting {
      background: #ffc107;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* ========== SLIDER STYLES ========== */
    input[type="range"] {
      width: 100%;
      max-width: 300px;
      height: 6px;
      border-radius: 3px;
      background: #ddd;
      outline: none;
      -webkit-appearance: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #667eea;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    input[type="range"]::-webkit-slider-thumb:hover {
      background: #5568d3;
      transform: scale(1.2);
    }
    
    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #667eea;
      cursor: pointer;
      border: none;
    }
    
    /* ========== BUTTON STYLES ========== */
    .reset-button, .test-button {
      background: #6c757d;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 15px;
      transition: all 0.3s;
    }
    
    .reset-button:hover, .test-button:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }
    
    .test-button {
      background: #28a745;
    }
    
    .test-button:hover {
      background: #218838;
    }
    
    .toggle-slider {
      position: absolute;
      width: 22px;
      height: 22px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: left 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .toggle-switch.active .toggle-slider {
      left: 26px;
    }

    /* ========== LOBBY/GAME/POSTGAME (keeping existing styles) ========== */
    #lobby-screen, #game-screen, #postgame-screen {
      display: none;
    }
    
    #game-3d-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 9999;
    }
    
    #game-3d-container canvas {
      display: block;
    }

    .hidden {
      display: none !important;
    }

    /* Utility */
    .text-center {
      text-align: center;
    }

    .mb-10 {
      margin-bottom: 10px;
    }

    .mt-20 {
      margin-top: 20px;
    }
    /* ========== SHOP STYLES ========== */
    .shop-tab {
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      padding: 12px 20px;
      font-size: 16px;
      cursor: pointer;
      color: #666;
      transition: all 0.3s;
    }

    .shop-tab:hover {
      color: #667eea;
    }

    .shop-tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
      font-weight: bold;
    }

    .shop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      padding: 20px 0;
    }

    .shop-item {
      background: white;
      border: 2px solid #ddd;
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
    }

    .shop-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      border-color: #667eea;
    }

    .shop-item.owned {
      border-color: #2ecc71;
      background: #f0fff4;
    }

    .shop-item-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .shop-item-name {
      font-weight: bold;
      font-size: 16px;
      color: #333;
      margin-bottom: 5px;
    }

    .shop-item-rarity {
      font-size: 12px;
      padding: 4px 12px;
      border-radius: 12px;
      display: inline-block;
      margin-bottom: 10px;
    }

    .rarity-common { background: #95a5a6; color: white; }
    .rarity-uncommon { background: #27ae60; color: white; }
    .rarity-rare { background: #3498db; color: white; }
    .rarity-epic { background: #9b59b6; color: white; }
    .rarity-legendary { background: #f39c12; color: white; }

    .shop-item-price {
      font-size: 20px;
      font-weight: bold;
      color: #f39c12;
      margin-bottom: 10px;
    }

    .shop-buy-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }

    .shop-buy-btn:hover {
      background: #764ba2;
    }

    .shop-buy-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .shop-owned-badge {
      background: #2ecc71;
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: bold;
    }

    .bundle-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
    }

    .bundle-items {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 10px;
      margin: 20px 0;
    }

    .bundle-item-icon {
      font-size: 32px;
      background: rgba(255,255,255,0.2);
      padding: 15px;
      border-radius: 10px;
    }
  </style>
</head>
<body>

  <!-- ========== AUTH SCREEN ========== -->
  <div id="auth-screen">
    <div class="auth-container">
      <h1 class="auth-title">üéÆ Pixelio</h1>
      <p class="auth-subtitle">Battle royale meets trivia!</p>

      <div class="auth-tabs">
        <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
        <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
      </div>

      <div id="auth-error" class="error-message"></div>
      <div id="auth-success" class="success-message"></div>

      <form id="login-form" class="auth-form active" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="login-email" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="login-password" required>
        </div>
        <button type="submit" class="auth-button">Login</button>
      </form>
      
      <div class="auth-divider">‚îÄ‚îÄ OR ‚îÄ‚îÄ</div>
      
      <button class="google-signin-btn" onclick="signInWithGoogle()">
        <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" style="margin-right: 12px;">
          <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>
          <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path>
          <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>
          <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>
        </svg>
        Continue with Google
      </button>

      <form id="signup-form" class="auth-form" onsubmit="handleSignup(event)">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="signup-username" minlength="3" maxlength="20" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="signup-email" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="signup-password" minlength="6" required>
        </div>
        <button type="submit" class="auth-button">Create Account</button>
      </form>

      <button class="guest-button" onclick="playAsGuest()">Continue as Guest</button>
    </div>
  </div>

  <!-- ========== MENU SCREEN ========== -->
  <div id="menu-screen">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="top-bar-left">
        <button class="top-button" onclick="openSettings()">‚öôÔ∏è Settings</button>
        <button class="top-button" onclick="toggleFriends()">
          üë• Friends
          <span id="friend-requests-badge" class="notification-badge">0</span>
        </button>
      </div>
      <div class="top-bar-right">
        <div class="coins-display">üí∞ <span id="coins-header">0</span></div>
        <button class="top-button" onclick="openLocker()">üéΩ Locker</button>
        <button class="top-button" onclick="openShop()">üõçÔ∏è Shop</button>
        <button class="top-button" onclick="openBattleTicket()">üé´ Battle Ticket</button>
        <button class="top-button" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- Main Menu -->
    <div class="menu-container">
      <h1 class="game-title">Pixelio</h1>
      <p class="game-subtitle">‚ö° Battle Royale meets Trivia ‚ö°</p>

      <div id="user-info" class="user-info">
        <h3 id="username-display"></h3>
        <div class="user-stats">
          <div class="stat">
            <div class="stat-value" id="level-display">1</div>
            <div class="stat-label">Level</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="wins-display">0</div>
            <div class="stat-label">Wins</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="coins-display">0</div>
            <div class="stat-label">Coins</div>
          </div>
        </div>
      </div>
      
      <!-- Skin Selector -->
      <div class="skin-selector">
        <h3>ü§ñ Choose Your Robot</h3>
        <div class="skin-grid" id="skin-grid">
          <!-- Skins will be populated here -->
        </div>
      </div>

      <div class="menu-buttons">
        <button class="menu-button primary-button" onclick="quickPlay()">‚ö° Quick Play</button>
        <button class="menu-button secondary-button" onclick="showJoinGameModal()">Join Private Game</button>
        <button class="menu-button secondary-button" onclick="createGame()">Create Private Game</button>
        <button id="admin-button" class="menu-button admin-button" onclick="openAdminPanel()" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); margin-top: 20px; display: none;">üõ†Ô∏è Admin Panel</button>
      </div>
    </div>

    <!-- Friends Sidebar -->
    <div class="friends-sidebar" id="friends-sidebar">
      <div class="friends-header">Friends</div>
      <div class="friends-tabs">
        <button class="friends-tab active" onclick="switchFriendsTab('friends')">Friends</button>
        <button class="friends-tab" onclick="switchFriendsTab('requests')">
          Requests
          <span id="requests-count" style="display:none;"></span>
        </button>
        <button class="friends-tab" onclick="switchFriendsTab('search')">Search</button>
      </div>
      <div class="friends-content">
        <!-- Friends Tab -->
        <div id="friends-tab-content" class="friends-tab-content">
          <div id="friends-list"></div>
        </div>

        <!-- Requests Tab -->
        <div id="requests-tab-content" class="friends-tab-content hidden">
          <div id="friend-requests-list"></div>
        </div>

        <!-- Search Tab -->
        <div id="search-tab-content" class="friends-tab-content hidden">
          <div class="friend-search">
            <input type="text" id="friend-search-input" placeholder="Search username..." onkeyup="searchUsers()">
          </div>
          <div id="search-results"></div>
        </div>
      </div>
    </div>

    <!-- Party Panel -->
    <div class="party-panel" id="party-panel">
      <div class="party-header">
        <span>Party</span>
        <button class="friend-button decline-button" onclick="leaveParty()">Leave</button>
      </div>
      <div id="party-members"></div>
      <button class="menu-button primary-button mt-20" onclick="partyReadyToggle()">Ready Up</button>
    </div>
  </div>

  <!-- ========== BATTLE TICKET MODAL ========== -->
  <div id="battle-ticket-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 800px;">
      <button class="modal-close" onclick="closeBattleTicket()">√ó</button>
      <div class="battle-ticket-header">
        <div class="season-title" id="season-name">Season 1: Brain Storm Rising</div>
        <div class="tier-display">Tier <span id="current-tier">0</span> / <span id="max-tier">50</span></div>
        <div class="xp-progress">
          <div class="xp-bar" id="xp-bar" style="width: 0%"></div>
        </div>
        <div class="text-center"><span id="xp-text">0 / 1000 XP</span></div>
      </div>

      <div id="premium-banner" class="premium-banner" onclick="buyPremium()">
        <h3>üåü Unlock Premium Battle Ticket üåü</h3>
        <p>Get exclusive rewards for only 950 coins!</p>
      </div>

      <div class="reward-tiers" id="reward-tiers-list"></div>
    </div>
  </div>

  <!-- ========== SETTINGS MODAL ========== -->
  <div id="settings-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow: hidden;">
      <button class="modal-close" onclick="closeSettings()">√ó</button>
      <h2 style="margin-bottom: 20px; color: #667eea;">‚öôÔ∏è Settings</h2>

      <!-- Settings Tabs -->
      <div class="settings-tabs">
        <button class="settings-tab active" onclick="switchSettingsTab('controls')" data-tab="controls">üéÆ Controls</button>
        <button class="settings-tab" onclick="switchSettingsTab('voice')" data-tab="voice">üé§ Voice</button>
        <button class="settings-tab" onclick="switchSettingsTab('audio')" data-tab="audio">üîä Audio</button>
        <button class="settings-tab" onclick="switchSettingsTab('graphics')" data-tab="graphics">üé® Graphics</button>
        <button class="settings-tab" onclick="switchSettingsTab('gameplay')" data-tab="gameplay">üéØ Gameplay</button>
        <button class="settings-tab" onclick="switchSettingsTab('privacy')" data-tab="privacy">üîí Privacy</button>
      </div>

      <!-- Settings Content Container -->
      <div class="settings-content" style="max-height: 500px; overflow-y: auto; padding: 20px; background: #f8f9fa; border-radius: 10px; margin: 20px 0;">
        
        <!-- CONTROLS TAB -->
        <div id="settings-controls" class="settings-panel active">
          <h3 style="margin-bottom: 15px;">üéÆ Controls & Keybinds</h3>
          
          <div class="settings-section">
            <h4>Build Controls</h4>
            <div class="setting-item">
              <span>Simple Build Mode</span>
              <div class="toggle-switch" id="simple-build-toggle" onclick="toggleSetting('simpleBuildMode')">
                <div class="toggle-slider"></div>
              </div>
            </div>
            <p class="setting-description">When enabled, one button builds all structures automatically</p>
            
            <div class="keybind-list">
              <div class="keybind-item">
                <span>Build Wall</span>
                <button class="keybind-button" onclick="changeKeybind('buildWall')" id="key-buildWall">Q</button>
              </div>
              <div class="keybind-item">
                <span>Build Floor</span>
                <button class="keybind-button" onclick="changeKeybind('buildFloor')" id="key-buildFloor">F</button>
              </div>
              <div class="keybind-item">
                <span>Build Stairs</span>
                <button class="keybind-button" onclick="changeKeybind('buildStair')" id="key-buildStair">V</button>
              </div>
              <div class="keybind-item">
                <span>Build Roof</span>
                <button class="keybind-button" onclick="changeKeybind('buildRoof')" id="key-buildRoof">G</button>
              </div>
            </div>
          </div>

          <div class="settings-section">
            <h4>Movement Controls</h4>
            <div class="keybind-list">
              <div class="keybind-item">
                <span>Move Forward</span>
                <button class="keybind-button" onclick="changeKeybind('moveForward')" id="key-moveForward">W</button>
              </div>
              <div class="keybind-item">
                <span>Move Back</span>
                <button class="keybind-button" onclick="changeKeybind('moveBack')" id="key-moveBack">S</button>
              </div>
              <div class="keybind-item">
                <span>Move Left</span>
                <button class="keybind-button" onclick="changeKeybind('moveLeft')" id="key-moveLeft">A</button>
              </div>
              <div class="keybind-item">
                <span>Move Right</span>
                <button class="keybind-button" onclick="changeKeybind('moveRight')" id="key-moveRight">D</button>
              </div>
              <div class="keybind-item">
                <span>Sprint</span>
                <button class="keybind-button" onclick="changeKeybind('sprint')" id="key-sprint">SHIFT</button>
              </div>
            </div>
          </div>

          <div class="settings-section">
            <h4>Action Controls</h4>
            <div class="keybind-list">
              <div class="keybind-item">
                <span>Interact</span>
                <button class="keybind-button" onclick="changeKeybind('interact')" id="key-interact">E</button>
              </div>
              <div class="keybind-item">
                <span>Reload</span>
                <button class="keybind-button" onclick="changeKeybind('reload')" id="key-reload">R</button>
              </div>
              <div class="keybind-item">
                <span>Inventory</span>
                <button class="keybind-button" onclick="changeKeybind('inventory')" id="key-inventory">TAB</button>
              </div>
              <div class="keybind-item">
                <span>Map</span>
                <button class="keybind-button" onclick="changeKeybind('map')" id="key-map">M</button>
              </div>
            </div>
          </div>

          <div class="settings-section">
            <h4>Mouse Settings</h4>
            <div class="setting-item">
              <span>Mouse Sensitivity: <span id="sensitivity-value">0.5</span></span>
              <input type="range" min="0.1" max="2" step="0.1" value="0.5" id="sensitivity-slider" oninput="updateSensitivity(this.value)">
            </div>
          </div>

          <button class="reset-button" onclick="resetControls()">Reset to Default</button>
        </div>

        <!-- VOICE CHAT TAB -->
        <div id="settings-voice" class="settings-panel">
          <h3 style="margin-bottom: 15px;">üé§ Voice Chat</h3>
          
          <div class="warning-box">
            <h4>‚ö†Ô∏è Voice Chat Safety</h4>
            <p>Voice chat connects you with other players. Communicate respectfully and never share personal information. Parents should monitor children's online interactions.</p>
          </div>

          <div class="settings-section">
            <div class="setting-item">
              <span>Enable Voice Chat</span>
              <div class="toggle-switch" id="voice-enabled-toggle" onclick="toggleSetting('voiceChatEnabled')">
                <div class="toggle-slider"></div>
              </div>
            </div>

            <div class="setting-item">
              <span>Who Can Talk To You</span>
              <select id="voice-mode-select" onchange="updateVoiceMode(this.value)" class="settings-select">
                <option value="off">Nobody (Disabled)</option>
                <option value="friends" selected>Friends Only</option>
                <option value="team">Team Members Only</option>
                <option value="everyone">Everyone</option>
              </select>
            </div>

            <div class="setting-item">
              <span>Push to Talk (Press to speak)</span>
              <div class="toggle-switch active" id="push-to-talk-toggle" onclick="toggleSetting('pushToTalk')">
                <div class="toggle-slider"></div>
              </div>
            </div>

            <div class="setting-item">
              <span>Voice Activation (Auto-detect)</span>
              <div class="toggle-switch" id="voice-activation-toggle" onclick="toggleSetting('voiceActivation')">
                <div class="toggle-slider"></div>
              </div>
            </div>

            <div class="setting-item">
              <span>Microphone Sensitivity: <span id="mic-sensitivity-value">50%</span></span>
              <input type="range" min="0" max="100" value="50" id="mic-sensitivity-slider" oninput="updateMicSensitivity(this.value)">
            </div>

            <div class="setting-item">
              <span>Voice Volume: <span id="voice-volume-value">100%</span></span>
              <input type="range" min="0" max="100" value="100" id="voice-volume-slider" oninput="updateVoiceVolume(this.value)">
            </div>
          </div>

          <button class="test-button" onclick="testMicrophone()">üé§ Test Microphone</button>
        </div>

        <!-- AUDIO TAB -->
        <div id="settings-audio" class="settings-panel">
          <h3 style="margin-bottom: 15px;">üîä Audio</h3>
          
          <div class="settings-section">
            <div class="setting-item">
              <span>Master Volume: <span id="master-volume-value">70%</span></span>
              <input type="range" min="0" max="100" value="70" id="master-volume-slider" oninput="updateMasterVolume(this.value)">
            </div>

            <div class="setting-item">
              <span>Music Volume: <span id="music-volume-value">50%</span></span>
              <input type="range" min="0" max="100" value="50" id="music-volume-slider" oninput="updateMusicVolume(this.value)">
            </div>

            <div class="setting-item">
              <span>Sound Effects Volume: <span id="sfx-volume-value">70%</span></span>
              <input type="range" min="0" max="100" value="70" id="sfx-volume-slider" oninput="updateSFXVolume(this.value)">
            </div>

            <div class="setting-item">
              <span>Enable Sound Effects</span>
              <div class="toggle-switch active" id="sfx-toggle" onclick="toggleSetting('soundEffects')">
                <div class="toggle-slider"></div>
              </div>
            </div>

            <div class="setting-item">
              <span>Enable Music</span>
              <div class="toggle-switch active" id="music-toggle" onclick="toggleSetting('music')">
                <div class="toggle-slider"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- GRAPHICS TAB -->
        <div id="settings-graphics" class="settings-panel">
          <h3 style="margin-bottom: 15px;">üé® Graphics</h3>
          
          <div class="settings-section">
            <div class="setting-item">
              <span>Graphics Quality</span>
              <select id="graphics-quality-select" onchange="updateGraphicsQuality(this.value)" class="settings-select">
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high" selected>High</option>
                <option value="ultra">Ultra</option>
              </select>
            </div>

            <div class="setting-item">
              <span>Show FPS Counter</span>
              <div class="toggle-switch" id="fps-toggle" onclick="toggleSetting('showFPS')">
                <div class="toggle-slider"></div>
              </div>
            </div>

            <div class="setting-item">
              <span>Show Ping</span>
              <div class="toggle-switch active" id="ping-toggle" onclick="toggleSetting('showPing')">
                <div class="toggle-slider"></div>
              </div>
            </div>

            <div class="setting-item">
              <span>Motion Blur</span>
              <div class="toggle-switch" id="motion-blur-toggle" onclick="toggleSetting('motionBlur')">
                <div class="toggle-slider"></div>
              </div>
            </div>

            <div class="setting-item">
              <span>Colorblind Mode</span>
              <select id="colorblind-select" onchange="updateColorblindMode(this.value)" class="settings-select">
                <option value="off" selected>Off</option>
                <option value="protanopia">Protanopia (Red-Weak)</option>
                <option value="deuteranopia">Deuteranopia (Green-Weak)</option>
                <option value="tritanopia">Tritanopia (Blue-Weak)</option>
              </select>
            </div>
          </div>
        </div>

        <!-- GAMEPLAY TAB -->
        <div id="settings-gameplay" class="settings-panel">
          <h3 style="margin-bottom: 15px;">üéØ Gameplay</h3>
          
          <div class="settings-section">
            <h4>Build Settings</h4>
            <div class="setting-item">
              <span>Simple Build Mode</span>
              <div class="toggle-switch" id="simple-build-toggle-2" onclick="toggleSetting('simpleBuildMode')">
                <div class="toggle-slider"></div>
              </div>
            </div>
            <p class="setting-description">Automatically select best building piece</p>

            <h4 style="margin-top: 20px;">Convenience</h4>
            <div class="setting-item">
              <span>Auto Pickup Items</span>
              <div class="toggle-switch active" id="auto-pickup-toggle" onclick="toggleSetting('autoPickup')">
                <div class="toggle-slider"></div>
              </div>
            </div>

            <div class="setting-item">
              <span>Auto Switch Weapons</span>
              <div class="toggle-switch active" id="auto-switch-toggle" onclick="toggleSetting('autoSwitchWeapon')">
                <div class="toggle-slider"></div>
              </div>
            </div>

            <div class="setting-item">
              <span>Show Damage Numbers</span>
              <div class="toggle-switch active" id="damage-numbers-toggle" onclick="toggleSetting('showDamageNumbers')">
                <div class="toggle-slider"></div>
              </div>
            </div>

            <div class="setting-item">
              <span>Show Kill Feed</span>
              <div class="toggle-switch active" id="kill-feed-toggle" onclick="toggleSetting('showKillFeed')">
                <div class="toggle-slider"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- PRIVACY TAB -->
        <div id="settings-privacy" class="settings-panel">
          <h3 style="margin-bottom: 15px;">üîí Privacy</h3>
          
          <div class="settings-section">
            <div class="setting-item">
              <span>Show Online Status</span>
              <div class="toggle-switch active" id="online-toggle" onclick="toggleSetting('showOnlineStatus')">
                <div class="toggle-slider"></div>
              </div>
            </div>

            <div class="setting-item">
              <span>Allow Friend Requests</span>
              <div class="toggle-switch active" id="friend-requests-toggle" onclick="toggleSetting('friendRequestsEnabled')">
                <div class="toggle-slider"></div>
              </div>
            </div>

            <div class="setting-item">
              <span>Allow Spectators</span>
              <div class="toggle-switch active" id="spectators-toggle" onclick="toggleSetting('allowSpectators')">
                <div class="toggle-slider"></div>
              </div>
            </div>

            <div class="setting-item">
              <span>Share Stats Publicly</span>
              <div class="toggle-switch active" id="share-stats-toggle" onclick="toggleSetting('shareStats')">
                <div class="toggle-slider"></div>
              </div>
            </div>

            <div class="setting-item">
              <span>Enable Text Chat</span>
              <div class="toggle-switch active" id="chat-toggle" onclick="toggleSetting('chatEnabled')">
                <div class="toggle-slider"></div>
              </div>
            </div>

            <div class="setting-item">
              <span>Profanity Filter</span>
              <div class="toggle-switch active" id="profanity-toggle" onclick="toggleSetting('profanityFilter')">
                <div class="toggle-slider"></div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
        <button class="secondary-button" onclick="closeSettings()">Cancel</button>
        <button class="auth-button" onclick="saveSettings()">üíæ Save Settings</button>
      </div>
    </div>
  </div>

  <!-- ========== LOCKER MODAL ========== -->
  <div id="locker-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 1100px; max-height: 90vh;">
      <button class="modal-close" onclick="closeLocker()">√ó</button>
      <h2 style="margin-bottom: 20px; color: #667eea;">üéΩ Locker - Equip Your Style</h2>
      
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
        <h3 style="margin: 0 0 10px 0;">üë§ Current Loadout</h3>
        <div style="display: flex; gap: 20px; align-items: center;">
          <div style="text-align: center;">
            <canvas id="locker-preview" width="120" height="120" style="background: rgba(255,255,255,0.2); border-radius: 10px;"></canvas>
            <div style="margin-top: 10px; font-weight: bold; font-size: 18px;" id="locker-skin-name">Classic Bot</div>
          </div>
          <div style="flex: 1;">
            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
              <div><strong>Skin:</strong> <span id="equipped-skin-display">Classic Bot</span></div>
              <div style="margin-top: 8px;"><strong>Trail:</strong> <span id="equipped-trail-display">Default</span></div>
              <div style="margin-top: 8px;"><strong>Emotes:</strong> <span id="equipped-emotes-display">Wave, Thumbs Up</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Locker Tabs -->
      <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd;">
        <button class="shop-tab active" onclick="switchLockerTab('skins')" data-tab="skins">üé® Skins</button>
        <button class="shop-tab" onclick="switchLockerTab('trails')" data-tab="trails">‚ú® Trails</button>
        <button class="shop-tab" onclick="switchLockerTab('emotes')" data-tab="emotes">üòÑ Emotes</button>
      </div>

      <!-- Locker Content -->
      <div style="max-height: 400px; overflow-y: auto; padding: 20px; background: #f8f9fa; border-radius: 10px;">
        
        <!-- SKINS TAB -->
        <div id="locker-skins" class="locker-tab-content active">
          <h3 style="margin-bottom: 15px;">Your Skins</h3>
          <div id="locker-skins-grid" class="shop-grid">
            <!-- Dynamically loaded -->
          </div>
        </div>

        <!-- TRAILS TAB -->
        <div id="locker-trails" class="locker-tab-content" style="display: none;">
          <h3 style="margin-bottom: 15px;">Your Trails</h3>
          <p style="color: #666;">Trails coming soon! Leave a colorful path as you move.</p>
          <div id="locker-trails-grid" class="shop-grid">
            <!-- Dynamically loaded -->
          </div>
        </div>

        <!-- EMOTES TAB -->
        <div id="locker-emotes" class="locker-tab-content" style="display: none;">
          <h3 style="margin-bottom: 15px;">Your Emotes</h3>
          <p style="color: #666;">Express yourself with emotes!</p>
          <div id="locker-emotes-grid" class="shop-grid">
            <!-- Dynamically loaded -->
          </div>
        </div>

      </div>

      <div style="margin-top: 20px; text-align: center;">
        <button class="auth-button" onclick="closeLocker()">Done</button>
      </div>
    </div>
  </div>

  <!-- ========== SHOP MODAL ========== -->
  <div id="shop-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
      <button class="modal-close" onclick="closeShop()">√ó</button>
      <h2 style="margin-bottom: 20px; color: #667eea;">üõçÔ∏è Item Shop</h2>
      
      <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
        <span style="font-size: 24px; font-weight: bold;">üí∞ Your Coins: <span id="shop-coins-display">0</span></span>
      </div>

      <!-- Shop Tabs -->
      <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd;">
        <button class="shop-tab active" onclick="switchShopTab('skins')" data-tab="skins">üé® Skins</button>
        <button class="shop-tab" onclick="switchShopTab('emotes')" data-tab="emotes">üòä Emotes</button>
        <button class="shop-tab" onclick="switchShopTab('trails')" data-tab="trails">‚ú® Trails</button>
        <button class="shop-tab" onclick="switchShopTab('weapon_skins')" data-tab="weapon_skins">üî´ Weapon Skins</button>
        <button class="shop-tab" onclick="switchShopTab('bundles')" data-tab="bundles">üì¶ Bundles</button>
      </div>

      <!-- Shop Content -->
      <div id="shop-content" style="min-height: 400px;">
        <p style="text-align: center; color: #666;">Loading shop...</p>
      </div>
    </div>
  </div>

  <!-- Simplified Lobby/Game screens for now - keeping your existing ones -->
  <div id="lobby-screen"></div>
  
  <!-- ADMIN PANEL -->
  <div id="admin-panel" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.95); z-index: 999999; overflow-y: auto;">
    <div style="max-width: 1200px; margin: 0 auto; padding: 40px 20px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1 style="color: white; font-size: 36px; margin: 0;">üõ†Ô∏è Admin Panel</h1>
        <button onclick="closeAdminPanel()" style="background: #ff4444; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold;">‚úï Close</button>
      </div>
      
      <!-- Tabs -->
      <div style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #333;">
        <button class="admin-tab active" onclick="switchAdminTab('players')" data-tab="players" style="background: none; border: none; color: white; padding: 15px 25px; font-size: 16px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600;">üë• Players</button>
        <button class="admin-tab" onclick="switchAdminTab('games')" data-tab="games" style="background: none; border: none; color: white; padding: 15px 25px; font-size: 16px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600;">üéÆ Games</button>
        <button class="admin-tab" onclick="switchAdminTab('broadcast')" data-tab="broadcast" style="background: none; border: none; color: white; padding: 15px 25px; font-size: 16px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600;">üì¢ Broadcast</button>
        <button class="admin-tab" onclick="switchAdminTab('coins')" data-tab="coins" style="background: none; border: none; color: white; padding: 15px 25px; font-size: 16px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600;">üí∞ Give Coins</button>
      </div>
      
      <!-- Players Tab -->
      <div id="admin-tab-players" class="admin-tab-content">
        <div style="background: #1a1a1a; border-radius: 12px; padding: 20px;">
          <h2 style="color: white; margin-bottom: 20px;">Player Management</h2>
          <div style="margin-bottom: 20px;">
            <input type="text" id="admin-player-search" placeholder="Search player by username..." style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #333; background: #222; color: white; font-size: 14px;" oninput="searchAdminPlayers()">
          </div>
          <div id="admin-players-list" style="color: white;"></div>
        </div>
      </div>
      
      <!-- Games Tab -->
      <div id="admin-tab-games" class="admin-tab-content" style="display: none;">
        <div style="background: #1a1a1a; border-radius: 12px; padding: 20px;">
          <h2 style="color: white; margin-bottom: 20px;">Active Games</h2>
          <div id="admin-games-list" style="color: white;"></div>
        </div>
      </div>
      
      <!-- Broadcast Tab -->
      <div id="admin-tab-broadcast" class="admin-tab-content" style="display: none;">
        <div style="background: #1a1a1a; border-radius: 12px; padding: 20px;">
          <h2 style="color: white; margin-bottom: 20px;">Send Global Message</h2>
          <textarea id="admin-broadcast-message" placeholder="Type your message here..." style="width: 100%; height: 150px; padding: 12px; border-radius: 8px; border: 2px solid #333; background: #222; color: white; font-size: 14px; resize: vertical; font-family: inherit;" maxlength="500"></textarea>
          <button onclick="sendAdminBroadcast()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; margin-top: 15px; width: 100%;">üì¢ Send to All Players</button>
          <p style="color: #888; font-size: 12px; margin-top: 10px;">This will appear as a notification for all online players</p>
        </div>
      </div>
      
      <!-- Coins Tab -->
      <div id="admin-tab-coins" class="admin-tab-content" style="display: none;">
        <div style="background: #1a1a1a; border-radius: 12px; padding: 20px;">
          <h2 style="color: white; margin-bottom: 20px;">Give Coins to Player</h2>
          <input type="text" id="admin-coins-username" placeholder="Player username" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #333; background: #222; color: white; font-size: 14px; margin-bottom: 15px;">
          <input type="number" id="admin-coins-amount" placeholder="Amount of coins" min="1" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #333; background: #222; color: white; font-size: 14px; margin-bottom: 15px;">
          <button onclick="givePlayerCoins()" style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #000; border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; width: 100%;">üí∞ Give Coins</button>
        </div>
      </div>
    </div>
  </div>
  
  <div id="game-screen">
    <!-- 3D GAME CONTAINER -->
    <div id="game-3d-container"></div>
    
    <!-- Keep 2D canvas hidden as fallback -->
    <canvas id="game-canvas" style="display: none;"></canvas>
    
    <!-- Chat Window (in-game) -->
    <div class="chat-window" id="game-chat">
      <div class="chat-header">Chat (Press Enter)</div>
      <div class="chat-messages" id="chat-messages"></div>
      <div class="chat-input-container">
        <input type="text" class="chat-input" id="chat-input" placeholder="Type a message..." maxlength="200">
      </div>
    </div>

    <!-- Voice Controls (in-game) -->
    <div class="voice-controls" id="voice-controls">
      <div class="mb-10">
        <span class="voice-indicator" id="voice-indicator"></span>
        <span>Voice Chat</span>
      </div>
      <button class="voice-button" id="ptt-button">Hold V to Talk</button>
    </div>
  </div>
  <div id="postgame-screen"></div>

  <script>
    // ========== GLOBAL STATE ==========
    let socket;
    let authToken = null;
    let currentUser = null;
    let currentGameCode = null;
    let isGuest = false;

    // ========== AUTH FUNCTIONS ==========
    function switchAuthTab(tab) {
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
      
      if (tab === 'login') {
        document.querySelector('.auth-tab').classList.add('active');
        document.getElementById('login-form').classList.add('active');
      } else {
        document.querySelectorAll('.auth-tab')[1].classList.add('active');
        document.getElementById('signup-form').classList.add('active');
      }
      hideMessages();
    }

    async function handleLogin(e) {
      e.preventDefault();
      hideMessages();
      
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      
      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          authToken = data.token;
          currentUser = data.user;
          localStorage.setItem('authToken', authToken);
          connectToGame();
        } else {
          showError(data.error);
        }
      } catch (error) {
        showError('Connection error. Please try again.');
      }
    }

    async function handleSignup(e) {
      e.preventDefault();
      hideMessages();
      
      const username = document.getElementById('signup-username').value;
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      
      try {
        const response = await fetch('/api/auth/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          authToken = data.token;
          currentUser = data.user;
          localStorage.setItem('authToken', authToken);
          showSuccess('Account created! Logging in...');
          setTimeout(() => connectToGame(), 1000);
        } else {
          showError(data.error);
        }
      } catch (error) {
        showError('Connection error. Please try again.');
      }
    }

    function playAsGuest() {
      isGuest = true;
      currentUser = {
        username: 'Guest' + Math.floor(Math.random() * 10000),
        stats: { level: 1, wins: 0, coins: 0 }
      };
      connectToGame();
    }

    function logout() {
      if (authToken) {
        fetch('/api/auth/logout', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
      }
      
      authToken = null;
      currentUser = null;
      isGuest = false;
      localStorage.removeItem('authToken');
      
      if (socket) socket.disconnect();
      
      location.reload();
    }

    function showError(message) {
      const errorDiv = document.getElementById('auth-error');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    function showSuccess(message) {
      const successDiv = document.getElementById('auth-success');
      successDiv.textContent = message;
      successDiv.style.display = 'block';
    }

    function hideMessages() {
      document.getElementById('auth-error').style.display = 'none';
      document.getElementById('auth-success').style.display = 'none';
    }

    // ========== SOCKET CONNECTION ==========
    function connectToGame() {
      socket = io({
        auth: { token: authToken || null }
      });
      
      socket.on('connect', () => {
        console.log('Connected to server');
        setupGameSockets();
        showMenuScreen();
        
        // Show admin button if user is admin
        if (currentUser && currentUser.isAdmin) {
          document.getElementById('admin-button').style.display = 'block';
          console.log('üëë Admin access granted');
        }
        
        if (!isGuest) {
          loadFriends();
          loadFriendRequests();
          loadBattleTicket();
        }
      });
      
      socket.on('game-created', (data) => {
        console.log('Game created!', data);
        currentGameCode = data.gameCode;
        showLobbyScreen();
      });
      
      socket.on('lobby-update', (data) => {
        console.log('Lobby update:', data);
        updateLobbyPlayers(data.players, data.host);
      });
      
      socket.on('game-joined', (data) => {
        console.log('Joined game!', data);
        currentGameCode = data.gameCode;
        showLobbyScreen();
      });
      
      socket.on('join-error', (data) => {
        console.error('Join error:', data);
        alert('‚ùå ' + data.message);
      });
      
      socket.on('game-started', (data) => {
        console.log('Game starting!', data);
        // Hide ALL other screens
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('lobby-screen').style.display = 'none';
        document.getElementById('auth-screen').style.display = 'none';
        // Show ONLY game screen
        document.getElementById('game-screen').style.display = 'block';
        // Initialize game canvas and start gameplay
        try {
          if (typeof initGame === 'function') {
            initGame(data);
            console.log('‚úÖ Game initialized successfully');
          } else {
            console.error('‚ùå initGame function not found');
            alert('Game initialization error! Refresh the page.');
          }
        } catch (error) {
          console.error('‚ùå Game initialization error:', error);
          alert('Game failed to start: ' + error.message);
          document.getElementById('game-screen').style.display = 'none';
          showMenuScreen();
        }
      });
      
      socket.on('error', (data) => {
        alert('‚ùå ' + data.message);
      });
      
      socket.on('user-info', (data) => {
        if (!isGuest && data.username) {
          currentUser.username = data.username;
        }
      });

      // Party events
      socket.on('party-created', (data) => {
        document.getElementById('party-panel').classList.add('active');
      });

      socket.on('party-update', (data) => {
        renderPartyMembers(data.members, data.leader);
      });

      socket.on('party-invite', (data) => {
        if (confirm(`${data.from} invited you to their party. Join?`)) {
          socket.emit('accept-party-invite', { partyId: data.partyId });
          document.getElementById('party-panel').classList.add('active');
        }
      });

      // Chat events
      socket.on('chat-message', (msg) => {
        addChatMessage(msg);
      });
      
      setupGameHandlers();
    }

    function showMenuScreen() {
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('menu-screen').style.display = 'block';
      updateUserDisplay();
      loadSkinSelector(); // Load robot skins!
    }
    
    function showLobbyScreen() {
      // Hide other screens
      document.getElementById('menu-screen').style.display = 'none';
      document.getElementById('game-screen').style.display = 'none';
      
      // Show lobby
      const lobbyScreen = document.getElementById('lobby-screen');
      lobbyScreen.style.display = 'block';
      
      // Create lobby UI
      lobbyScreen.innerHTML = `
        <div style="padding: 40px; max-width: 800px; margin: 0 auto;">
          <h1 style="color: white; text-align: center; margin-bottom: 20px;">üéÆ Game Lobby</h1>
          <div style="background: rgba(255,255,255,0.95); padding: 30px; border-radius: 20px; margin-bottom: 20px;">
            <h2 style="text-align: center; color: #667eea; margin-bottom: 10px;">Game Code</h2>
            <div style="font-size: 48px; font-weight: bold; text-align: center; color: #764ba2; letter-spacing: 8px;">
              ${currentGameCode || 'LOADING...'}
            </div>
            <p style="text-align: center; color: #666; margin-top: 10px;">Share this code with friends!</p>
          </div>
          
          <div style="background: rgba(255,255,255,0.95); padding: 30px; border-radius: 20px; margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 15px;">Players in Lobby</h3>
            <div id="lobby-players-list" style="min-height: 100px;">
              <p style="color: #666; text-align: center;">Waiting for players...</p>
            </div>
          </div>
          
          <div style="text-align: center;">
            <button id="ready-toggle-btn" style="background: #95a5a6; color: white; border: none; padding: 15px 40px; font-size: 18px; border-radius: 10px; cursor: pointer; margin-right: 10px;">
              ‚è≥ Ready Up
            </button>
            <button id="start-game-btn" style="display: none; background: #2ecc71; color: white; border: none; padding: 15px 40px; font-size: 18px; border-radius: 10px; cursor: pointer; margin-right: 10px;">
              üöÄ Start Game
            </button>
            <button id="leave-lobby-btn" style="background: #e74c3c; color: white; border: none; padding: 15px 40px; font-size: 18px; border-radius: 10px; cursor: pointer;">
              üö™ Leave Lobby
            </button>
          </div>
          
          <div id="lobby-status" style="margin-top: 20px; text-align: center; color: white; font-size: 16px;">
            <!-- Status messages will appear here -->
          </div>
        </div>
      `;
      
      // Add event listeners
      const readyBtn = document.getElementById('ready-toggle-btn');
      const startBtn = document.getElementById('start-game-btn');
      const leaveBtn = document.getElementById('leave-lobby-btn');
      
      if (readyBtn) {
        readyBtn.addEventListener('click', () => {
          socket.emit('toggle-ready');
        });
      }
      
      if (startBtn) {
        startBtn.addEventListener('click', () => {
          socket.emit('start-game');
        });
      }
      
      if (leaveBtn) {
        leaveBtn.addEventListener('click', () => {
          socket.emit('leave-game');
          showMenuScreen();
          lobbyScreen.style.display = 'none';
        });
      }
    }

    function updateLobbyPlayers(players, hostId) {
      const playersList = document.getElementById('lobby-players-list');
      if (!playersList) return;
      
      // Count ready players
      const readyCount = players.filter(p => p.isReady).length;
      const totalCount = players.length;
      const allReady = readyCount === totalCount;
      
      playersList.innerHTML = players.map(player => `
        <div style="padding: 15px; background: ${player.id === hostId ? '#ffeaa7' : '#f5f5f5'}; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <strong style="font-size: 18px;">${player.username}</strong>
            ${player.id === hostId ? '<span style="color: #fdcb6e; margin-left: 10px;">üëë Host</span>' : ''}
          </div>
          <div style="color: ${player.isReady ? '#2ecc71' : '#95a5a6'}; font-weight: bold;">
            ${player.isReady ? '‚úÖ Ready' : '‚è≥ Not Ready'}
          </div>
        </div>
      `).join('');
      
      // Update ready button for current player
      const currentPlayer = players.find(p => p.id === socket.id);
      const readyBtn = document.getElementById('ready-toggle-btn');
      if (readyBtn && currentPlayer) {
        if (currentPlayer.isReady) {
          readyBtn.style.background = '#2ecc71';
          readyBtn.textContent = '‚úÖ Ready!';
        } else {
          readyBtn.style.background = '#95a5a6';
          readyBtn.textContent = '‚è≥ Ready Up';
        }
      }
      
      // Show start button only if you're the host
      const startBtn = document.getElementById('start-game-btn');
      if (startBtn && socket.id === hostId) {
        startBtn.style.display = 'inline-block';
        
        // Enable/disable based on all ready
        if (allReady) {
          startBtn.disabled = false;
          startBtn.style.opacity = '1';
          startBtn.style.cursor = 'pointer';
        } else {
          startBtn.disabled = true;
          startBtn.style.opacity = '0.5';
          startBtn.style.cursor = 'not-allowed';
        }
      }
      
      // Update status message
      const statusDiv = document.getElementById('lobby-status');
      if (statusDiv) {
        if (socket.id === hostId) {
          if (allReady) {
            statusDiv.innerHTML = '<span style="color: #2ecc71; font-weight: bold;">‚úÖ All players ready! Click Start Game!</span>';
          } else {
            statusDiv.innerHTML = `<span style="color: #f39c12;">‚è≥ Waiting for players... (${readyCount}/${totalCount} ready)</span>`;
          }
        } else {
          if (currentPlayer && currentPlayer.isReady) {
            statusDiv.innerHTML = '<span style="color: #2ecc71;">‚úÖ You are ready! Waiting for host to start...</span>';
          } else {
            statusDiv.innerHTML = '<span style="color: #f39c12;">‚è≥ Click "Ready Up" when you\'re ready to play!</span>';
          }
        }
      }
    }

    function updateUserDisplay() {
      document.getElementById('username-display').textContent = 
        currentUser.username + (isGuest ? ' (Guest)' : '');
      document.getElementById('level-display').textContent = currentUser.stats.level;
      document.getElementById('wins-display').textContent = currentUser.stats.wins;
      document.getElementById('coins-display').textContent = currentUser.stats.coins;
      document.getElementById('coins-header').textContent = currentUser.stats.coins;
      
      if (isGuest) {
        document.getElementById('user-info').style.borderColor = '#ff9900';
      }
    }

    // ========== FRIENDS SYSTEM ==========
    function toggleFriends() {
      document.getElementById('friends-sidebar').classList.toggle('open');
    }

    function switchFriendsTab(tab) {
      document.querySelectorAll('.friends-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.friends-tab-content').forEach(c => c.classList.add('hidden'));
      
      event.target.classList.add('active');
      
      if (tab === 'friends') {
        document.getElementById('friends-tab-content').classList.remove('hidden');
      } else if (tab === 'requests') {
        document.getElementById('requests-tab-content').classList.remove('hidden');
      } else if (tab === 'search') {
        document.getElementById('search-tab-content').classList.remove('hidden');
      }
    }

    async function loadFriends() {
      try {
        const res = await fetch('/api/friends/list', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const friends = await res.json();
        renderFriendsList(friends);
      } catch (error) {
        console.error('Load friends error:', error);
      }
    }

    function renderFriendsList(friends) {
      const listEl = document.getElementById('friends-list');
      listEl.innerHTML = '';
      
      if (friends.length === 0) {
        listEl.innerHTML = '<p style="text-align:center;color:#999;">No friends yet</p>';
        return;
      }
      
      friends.forEach(friend => {
        const item = document.createElement('div');
        item.className = 'friend-item';
        item.innerHTML = `
          <div class="friend-info">
            <div class="friend-name">
              <span class="${friend.isOnline ? 'online' : 'offline'}-indicator"></span>
              ${friend.username}
            </div>
            <div class="friend-status">
              Level ${friend.level} ${friend.inGame ? '‚Ä¢ In Game' : ''}
            </div>
          </div>
          <div class="friend-actions">
            <button class="friend-button invite-button" onclick="inviteToParty('${friend.id}')">Invite</button>
          </div>
        `;
        listEl.appendChild(item);
      });
    }

    async function loadFriendRequests() {
      try {
        const res = await fetch('/api/friends/requests', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const requests = await res.json();
        renderFriendRequests(requests);
        
        const badge = document.getElementById('friend-requests-badge');
        if (requests.length > 0) {
          badge.textContent = requests.length;
          badge.classList.add('active');
          document.getElementById('requests-count').textContent = ` (${requests.length})`;
          document.getElementById('requests-count').style.display = 'inline';
        }
      } catch (error) {
        console.error('Load requests error:', error);
      }
    }

    function renderFriendRequests(requests) {
      const listEl = document.getElementById('friend-requests-list');
      listEl.innerHTML = '';
      
      if (requests.length === 0) {
        listEl.innerHTML = '<p style="text-align:center;color:#999;">No pending requests</p>';
        return;
      }
      
      requests.forEach(req => {
        const item = document.createElement('div');
        item.className = 'friend-item';
        item.innerHTML = `
          <div class="friend-info">
            <div class="friend-name">${req.from.username}</div>
            <div class="friend-status">Level ${req.from.level}</div>
          </div>
          <div class="friend-actions">
            <button class="friend-button accept-button" onclick="acceptFriendRequest('${req.id}')">‚úì</button>
            <button class="friend-button decline-button" onclick="declineFriendRequest('${req.id}')">‚úó</button>
          </div>
        `;
        listEl.appendChild(item);
      });
    }

    async function acceptFriendRequest(requestId) {
      try {
        await fetch('/api/friends/accept', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ requestId })
        });
        loadFriends();
        loadFriendRequests();
      } catch (error) {
        console.error('Accept error:', error);
      }
    }

    async function declineFriendRequest(requestId) {
      try {
        await fetch('/api/friends/decline', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ requestId })
        });
        loadFriendRequests();
      } catch (error) {
        console.error('Decline error:', error);
      }
    }

    let searchTimeout;
    async function searchUsers() {
      clearTimeout(searchTimeout);
      const query = document.getElementById('friend-search-input').value;
      
      if (query.length < 2) {
        document.getElementById('search-results').innerHTML = '';
        return;
      }
      
      searchTimeout = setTimeout(async () => {
        try {
          const res = await fetch(`/api/friends/search?query=${encodeURIComponent(query)}`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
          });
          const results = await res.json();
          renderSearchResults(results);
        } catch (error) {
          console.error('Search error:', error);
        }
      }, 300);
    }

    function renderSearchResults(results) {
      const listEl = document.getElementById('search-results');
      listEl.innerHTML = '';
      
      if (results.length === 0) {
        listEl.innerHTML = '<p style="text-align:center;color:#999;">No users found</p>';
        return;
      }
      
      results.forEach(user => {
        const item = document.createElement('div');
        item.className = 'friend-item';
        
        let actionButton = '';
        if (user.isFriend) {
          actionButton = '<span style="color: #44ff44;">‚úì Friends</span>';
        } else if (user.isBlocked) {
          actionButton = '<span style="color: #ff4444;">Blocked</span>';
        } else {
          actionButton = `<button class="friend-button invite-button" onclick="sendFriendRequest('${user.username}')">Add Friend</button>`;
        }
        
        item.innerHTML = `
          <div class="friend-info">
            <div class="friend-name">${user.username}</div>
            <div class="friend-status">Level ${user.level}</div>
          </div>
          <div class="friend-actions">${actionButton}</div>
        `;
        listEl.appendChild(item);
      });
    }

    async function sendFriendRequest(username) {
      try {
        const res = await fetch('/api/friends/request', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username })
        });
        const data = await res.json();
        
        if (res.ok) {
          alert('Friend request sent!');
          searchUsers(); // Refresh search results
        } else {
          alert(data.error);
        }
      } catch (error) {
        console.error('Send request error:', error);
      }
    }

    // ========== PARTY SYSTEM ==========
    function createParty() {
      if (isGuest) {
        alert('Guests cannot create parties');
        return;
      }
      socket.emit('create-party');
    }

    function inviteToParty(userId) {
      socket.emit('invite-to-party', { userId });
      alert('Invite sent!');
    }

    function leaveParty() {
      socket.emit('leave-party');
      document.getElementById('party-panel').classList.remove('active');
    }

    function partyReadyToggle() {
      socket.emit('party-ready-toggle');
    }

    function renderPartyMembers(members, leaderId) {
      const container = document.getElementById('party-members');
      container.innerHTML = '';
      
      members.forEach(member => {
        const div = document.createElement('div');
        div.className = 'party-member';
        if (member.ready) div.classList.add('ready');
        if (member.userId === leaderId) div.classList.add('leader');
        
        div.innerHTML = `
          <span>${member.username} ${member.userId === leaderId ? 'üëë' : ''}</span>
          <span>${member.ready ? '‚úì Ready' : '‚è≥'}</span>
        `;
        container.appendChild(div);
      });
    }

    // ========== BATTLE TICKET ==========
    async function loadBattleTicket() {
      try {
        const res = await fetch('/api/battle-ticket/status', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const data = await res.json();
        renderBattleTicketStatus(data);
      } catch (error) {
        console.error('Load battle ticket error:', error);
      }
    }

    function renderBattleTicketStatus(data) {
      document.getElementById('season-name').textContent = `Season ${data.season}: ${data.seasonName}`;
      document.getElementById('current-tier').textContent = data.currentTier;
      document.getElementById('max-tier').textContent = data.maxTier;
      
      const progress = (data.xpProgress / data.xpNeeded) * 100;
      document.getElementById('xp-bar').style.width = progress + '%';
      document.getElementById('xp-text').textContent = `${data.xpProgress} / ${data.xpNeeded} XP`;
      
      if (data.hasPremium) {
        document.getElementById('premium-banner').style.display = 'none';
      }
    }

    async function openBattleTicket() {
      if (isGuest) {
        alert('Battle Ticket is only available for registered users');
        return;
      }
      
      await loadBattleTicket();
      await loadBattleTicketRewards();
      document.getElementById('battle-ticket-modal').classList.add('active');
    }

    function closeBattleTicket() {
      document.getElementById('battle-ticket-modal').classList.remove('active');
    }

    async function loadBattleTicketRewards() {
      try {
        const res = await fetch('/api/battle-ticket/rewards', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const rewards = await res.json();
        renderRewardTiers(rewards);
      } catch (error) {
        console.error('Load rewards error:', error);
      }
    }

    function renderRewardTiers(tiers) {
      const container = document.getElementById('reward-tiers-list');
      container.innerHTML = '';
      
      tiers.forEach(tier => {
        const div = document.createElement('div');
        div.className = 'reward-tier';
        if (tier.locked) div.classList.add('locked');
        if (tier.claimed) div.classList.add('claimed');
        
        let rewardsHtml = '';
        [...tier.free, ...tier.premium].forEach(reward => {
          const isPremium = tier.premium.includes(reward);
          rewardsHtml += `<div class="reward-item ${isPremium ? 'premium' : ''}">
            ${getRewardDisplay(reward)}
          </div>`;
        });
        
        div.innerHTML = `
          <div class="tier-number">Tier ${tier.tier}</div>
          <div class="tier-rewards">${rewardsHtml}</div>
          ${!tier.locked && !tier.claimed ? `<button class="claim-button" onclick="claimReward(${tier.tier})">Claim Rewards</button>` : ''}
          ${tier.claimed ? '<div style="text-align:center;color:#44ff44;font-weight:bold;margin-top:10px;">‚úì Claimed</div>' : ''}
          ${tier.locked ? '<div style="text-align:center;color:#999;margin-top:10px;">üîí Locked</div>' : ''}
        `;
        
        container.appendChild(div);
      });
    }

    function getRewardDisplay(reward) {
      if (reward.type === 'coins') return `üí∞ ${reward.amount} Coins`;
      if (reward.type === 'xp_boost') return `‚ö° ${reward.amount} XP`;
      if (reward.type === 'skin') return `üë§ ${reward.id}`;
      if (reward.type === 'emote') return `üòä ${reward.id}`;
      if (reward.type === 'trail') return `‚ú® ${reward.id}`;
      return reward.type;
    }

    async function claimReward(tier) {
      try {
        const res = await fetch(`/api/battle-ticket/claim/${tier}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const data = await res.json();
        
        if (res.ok) {
          alert('Rewards claimed! ' + data.items.map(i => getRewardDisplay(i)).join(', '));
          currentUser.stats.coins = data.coins;
          updateUserDisplay();
          loadBattleTicket();
          loadBattleTicketRewards();
        } else {
          alert(data.error);
        }
      } catch (error) {
        console.error('Claim error:', error);
      }
    }

    async function buyPremium() {
      if (confirm('Purchase Premium Battle Ticket for 950 coins?')) {
        try {
          const res = await fetch('/api/battle-ticket/buy-premium', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${authToken}` }
          });
          const data = await res.json();
          
          if (res.ok) {
            alert('Premium Battle Ticket purchased!');
            currentUser.stats.coins = data.coins;
            updateUserDisplay();
            loadBattleTicket();
          } else {
            alert(data.error);
          }
        } catch (error) {
          console.error('Buy premium error:', error);
        }
      }
    }

    // ========== CHAT SYSTEM ==========
    function addChatMessage(msg) {
      const container = document.getElementById('chat-messages');
      const div = document.createElement('div');
      div.className = 'chat-message';
      div.innerHTML = `<span class="chat-username">${msg.username}:</span> ${msg.message}`;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    // Chat input handling
    document.addEventListener('DOMContentLoaded', () => {
      const chatInput = document.getElementById('chat-input');
      if (chatInput) {
        chatInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && chatInput.value.trim()) {
            socket.emit('send-chat-message', { message: chatInput.value });
            chatInput.value = '';
          }
        });
      }
    });

    // ========== SETTINGS ==========
    function openSettings() {
      document.getElementById('settings-modal').classList.add('active');
      loadUserSettings();
    }

    function closeSettings() {
      document.getElementById('settings-modal').classList.remove('active');
    }

    // ========== SETTINGS MANAGEMENT ==========
    let currentSettings = {
      // Audio
      masterVolume: 0.7,
      musicVolume: 0.5,
      sfxVolume: 0.7,
      voiceVolume: 1.0,
      soundEffects: true,
      music: true,
      
      // Voice Chat
      voiceChatEnabled: false,
      voiceChatMode: 'friends',
      pushToTalk: true,
      voiceActivation: false,
      micSensitivity: 0.5,
      
      // Chat
      chatEnabled: true,
      profanityFilter: true,
      showTimestamps: false,
      chatOpacity: 0.8,
      
      // Controls
      keybinds: {
        moveForward: 'w',
        moveBack: 's',
        moveLeft: 'a',
        moveRight: 'd',
        sprint: 'shift',
        interact: 'e',
        reload: 'r',
        buildWall: 'q',
        buildFloor: 'f',
        buildStair: 'v',
        buildRoof: 'g',
        inventory: 'tab',
        map: 'm'
      },
      mouseSensitivity: 0.5,
      
      // Gameplay
      simpleBuildMode: false,
      autoPickup: true,
      autoSwitchWeapon: true,
      showDamageNumbers: true,
      showKillFeed: true,
      
      // Graphics
      graphicsQuality: 'high',
      showFPS: false,
      showPing: true,
      motionBlur: false,
      colorblindMode: 'off',
      
      // Privacy
      showOnlineStatus: true,
      friendRequestsEnabled: true,
      allowSpectators: true,
      shareStats: true
    };
    
    let waitingForKeybind = null;
    
    function switchSettingsTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.currentTarget.classList.add('active');
      
      // Update panels
      document.querySelectorAll('.settings-panel').forEach(panel => {
        panel.classList.remove('active');
      });
      document.getElementById('settings-' + tabName).classList.add('active');
    }
    
    async function loadUserSettings() {
      if (isGuest) {
        // Load from localStorage for guests
        const saved = localStorage.getItem('guestSettings');
        if (saved) {
          currentSettings = { ...currentSettings, ...JSON.parse(saved) };
        }
        updateSettingsUI();
        return;
      }
      
      try {
        const res = await fetch('/api/auth/profile', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const data = await res.json();
        
        if (data.settings) {
          currentSettings = { ...currentSettings, ...data.settings };
          updateSettingsUI();
        }
      } catch (error) {
        console.error('Load settings error:', error);
      }
    }

    function updateSettingsUI() {
      // Update all toggle switches
      const toggles = {
        'simple-build-toggle': currentSettings.simpleBuildMode,
        'simple-build-toggle-2': currentSettings.simpleBuildMode,
        'voice-enabled-toggle': currentSettings.voiceChatEnabled,
        'push-to-talk-toggle': currentSettings.pushToTalk,
        'voice-activation-toggle': currentSettings.voiceActivation,
        'sfx-toggle': currentSettings.soundEffects,
        'music-toggle': currentSettings.music,
        'fps-toggle': currentSettings.showFPS,
        'ping-toggle': currentSettings.showPing,
        'motion-blur-toggle': currentSettings.motionBlur,
        'auto-pickup-toggle': currentSettings.autoPickup,
        'auto-switch-toggle': currentSettings.autoSwitchWeapon,
        'damage-numbers-toggle': currentSettings.showDamageNumbers,
        'kill-feed-toggle': currentSettings.showKillFeed,
        'online-toggle': currentSettings.showOnlineStatus,
        'friend-requests-toggle': currentSettings.friendRequestsEnabled,
        'spectators-toggle': currentSettings.allowSpectators,
        'share-stats-toggle': currentSettings.shareStats,
        'chat-toggle': currentSettings.chatEnabled,
        'profanity-toggle': currentSettings.profanityFilter
      };
      
      Object.entries(toggles).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
          element.classList.toggle('active', value);
        }
      });
      
      // Update sliders
      updateSlider('sensitivity', currentSettings.mouseSensitivity);
      updateSlider('mic-sensitivity', currentSettings.micSensitivity * 100);
      updateSlider('voice-volume', currentSettings.voiceVolume * 100);
      updateSlider('master-volume', currentSettings.masterVolume * 100);
      updateSlider('music-volume', currentSettings.musicVolume * 100);
      updateSlider('sfx-volume', currentSettings.sfxVolume * 100);
      
      // Update selects
      setSelect('voice-mode-select', currentSettings.voiceChatMode);
      setSelect('graphics-quality-select', currentSettings.graphicsQuality);
      setSelect('colorblind-select', currentSettings.colorblindMode);
      
      // Update keybinds
      if (currentSettings.keybinds) {
        Object.entries(currentSettings.keybinds).forEach(([action, key]) => {
          const btn = document.getElementById('key-' + action);
          if (btn) {
            btn.textContent = key.toUpperCase();
          }
        });
      }
    }
    
    function updateSlider(name, value) {
      const slider = document.getElementById(name + '-slider');
      const display = document.getElementById(name + '-value');
      if (slider) slider.value = value;
      if (display) {
        if (name === 'sensitivity') {
          display.textContent = value.toFixed(1);
        } else {
          display.textContent = Math.round(value) + '%';
        }
      }
    }
    
    function setSelect(id, value) {
      const select = document.getElementById(id);
      if (select) select.value = value;
    }
    
    function toggleSetting(setting) {
      const toggle = event.currentTarget;
      const isActive = toggle.classList.toggle('active');
      currentSettings[setting] = isActive;
      
      console.log(`Setting ${setting} = ${isActive}`);
    }
    
    // ========== VOLUME CONTROLS ==========
    function updateMasterVolume(value) {
      currentSettings.masterVolume = value / 100;
      document.getElementById('master-volume-value').textContent = Math.round(value) + '%';
    }
    
    function updateMusicVolume(value) {
      currentSettings.musicVolume = value / 100;
      document.getElementById('music-volume-value').textContent = Math.round(value) + '%';
    }
    
    function updateSFXVolume(value) {
      currentSettings.sfxVolume = value / 100;
      document.getElementById('sfx-volume-value').textContent = Math.round(value) + '%';
    }
    
    function updateVoiceVolume(value) {
      currentSettings.voiceVolume = value / 100;
      document.getElementById('voice-volume-value').textContent = Math.round(value) + '%';
    }
    
    function updateMicSensitivity(value) {
      currentSettings.micSensitivity = value / 100;
      document.getElementById('mic-sensitivity-value').textContent = Math.round(value) + '%';
    }
    
    function updateSensitivity(value) {
      currentSettings.mouseSensitivity = parseFloat(value);
      document.getElementById('sensitivity-value').textContent = value;
    }
    
    // ========== VOICE CHAT ==========
    function updateVoiceMode(value) {
      currentSettings.voiceChatMode = value;
      console.log('Voice mode set to:', value);
      
      if (value === 'everyone') {
        if (!confirm('‚ö†Ô∏è This will allow ANYONE to talk to you. Are you sure?')) {
          document.getElementById('voice-mode-select').value = currentSettings.voiceChatMode;
          return;
        }
      }
    }
    
    function testMicrophone() {
      alert('üé§ Microphone Test\n\nSpeak into your microphone. If you see a green indicator, it\'s working!\n\n(Full implementation requires WebRTC)');
      // TODO: Implement actual mic test with Web Audio API
    }
    
    // ========== GRAPHICS ==========
    function updateGraphicsQuality(value) {
      currentSettings.graphicsQuality = value;
      console.log('Graphics quality set to:', value);
    }
    
    function updateColorblindMode(value) {
      currentSettings.colorblindMode = value;
      console.log('Colorblind mode set to:', value);
      // TODO: Apply color filters
    }
    
    // ========== KEYBINDINGS ==========
    function changeKeybind(action) {
      const button = event.currentTarget;
      button.classList.add('waiting');
      button.textContent = 'Press Key...';
      waitingForKeybind = action;
      
      // Listen for next keypress
      const keyListener = (e) => {
        e.preventDefault();
        const key = e.key.toLowerCase();
        
        // Cancel if escape
        if (key === 'escape') {
          button.classList.remove('waiting');
          button.textContent = currentSettings.keybinds[action].toUpperCase();
          waitingForKeybind = null;
          document.removeEventListener('keydown', keyListener);
          return;
        }
        
        // Update keybind
        currentSettings.keybinds[action] = key;
        button.classList.remove('waiting');
        button.textContent = key.toUpperCase();
        waitingForKeybind = null;
        document.removeEventListener('keydown', keyListener);
        
        console.log(`Keybind ${action} set to ${key}`);
      };
      
      document.addEventListener('keydown', keyListener);
    }
    
    function resetControls() {
      if (!confirm('Reset all controls to default?')) return;
      
      currentSettings.keybinds = {
        moveForward: 'w',
        moveBack: 's',
        moveLeft: 'a',
        moveRight: 'd',
        sprint: 'shift',
        interact: 'e',
        reload: 'r',
        buildWall: 'q',
        buildFloor: 'f',
        buildStair: 'v',
        buildRoof: 'g',
        inventory: 'tab',
        map: 'm'
      };
      
      currentSettings.mouseSensitivity = 0.5;
      currentSettings.simpleBuildMode = false;
      
      updateSettingsUI();
      alert('‚úÖ Controls reset to default!');
    }
    
    // ========== SAVE SETTINGS ==========
    async function saveSettings() {
      try {
        if (isGuest) {
          // Save to localStorage for guests
          localStorage.setItem('guestSettings', JSON.stringify(currentSettings));
          alert('‚úÖ Settings saved locally!');
          closeSettings();
          return;
        }
        
        const res = await fetch('/api/auth/profile', {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ settings: currentSettings })
        });
        
        if (res.ok) {
          alert('‚úÖ Settings saved!');
          closeSettings();
          
          // Apply settings immediately
          applySettings();
        } else {
          alert('‚ùå Failed to save settings');
        }
      } catch (error) {
        console.error('Save settings error:', error);
        alert('‚ùå Error saving settings');
      }
    }
    
    function applySettings() {
      // Apply audio settings
      if (window.audioContext) {
        // TODO: Apply audio settings to game
      }
      
      // Apply graphics settings
      if (currentSettings.showFPS) {
        // TODO: Show FPS counter
      }
      
      // Apply keybinds to game controls
      if (typeof keys !== 'undefined') {
        // Keybinds will be read from currentSettings.keybinds
      }
      
      console.log('Settings applied:', currentSettings);
    }

    // ========== GAME FUNCTIONS (simplified for now) ==========
    function setupGameHandlers() {
      // Add your existing game handlers here
    }

    function quickPlay() {
      alert('Quick Play coming soon!');
    }

    function showJoinGameModal() {
      const code = prompt('Enter game code:');
      if (code) {
        socket.emit('join-game', {
          gameCode: code,
          username: currentUser.username,
          skin: selectedSkin || 'default'
        });
      }
    }

    // ========== SHOP FUNCTIONS ==========
    let currentShopTab = 'skins';
    
    async function openShop() {
      document.getElementById('shop-modal').classList.add('active');
      document.getElementById('shop-coins-display').textContent = currentUser.stats.coins;
      await loadShopItems('skins');
    }
    
    function closeShop() {
      document.getElementById('shop-modal').classList.remove('active');
    }
    
    // ========== LOCKER SYSTEM ==========
    function openLocker() {
      document.getElementById('locker-modal').classList.add('active');
      loadLockerItems();
      updateLockerPreview();
    }
    
    function closeLocker() {
      document.getElementById('locker-modal').classList.remove('active');
    }
    
    function switchLockerTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.shop-tab').forEach(btn => {
        btn.classList.remove('active');
      });
      event.currentTarget.classList.add('active');
      
      // Update content
      document.querySelectorAll('.locker-tab-content').forEach(content => {
        content.style.display = 'none';
      });
      document.getElementById('locker-' + tab).style.display = 'block';
    }
    
    function loadLockerItems() {
      if (!currentUser || !currentUser.inventory) return;
      
      const ownedSkins = currentUser.inventory.ownedSkins || ['default'];
      const equippedSkin = currentUser.inventory.equippedSkin || 'default';
      
      const skinsGrid = document.getElementById('locker-skins-grid');
      skinsGrid.innerHTML = '';
      
      ownedSkins.forEach(skinId => {
        const skin = CharacterRenderer.skins[skinId];
        if (!skin) return;
        
        const card = document.createElement('div');
        card.className = 'shop-item';
        card.style.cursor = 'pointer';
        card.style.position = 'relative';
        
        // Equipped indicator
        if (skinId === equippedSkin) {
          card.style.border = '3px solid #00ff00';
          card.style.boxShadow = '0 0 20px rgba(0, 255, 0, 0.5)';
          
          const equipped = document.createElement('div');
          equipped.style.cssText = `
            position: absolute;
            top: 10px;
            right: 10px;
            background: #00ff00;
            color: white;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
          `;
          equipped.textContent = '‚úì EQUIPPED';
          card.appendChild(equipped);
        }
        
        const preview = document.createElement('canvas');
        preview.width = 100;
        preview.height = 100;
        preview.style.width = '100%';
        preview.style.height = 'auto';
        
        const ctx = preview.getContext('2d');
        ctx.save();
        ctx.translate(50, 50);
        try {
          CharacterRenderer.render(ctx, skinId, 30);
        } catch (e) {
          console.error('Render error:', e);
        }
        ctx.restore();
        
        const name = document.createElement('div');
        name.style.cssText = 'margin-top: 10px; font-weight: bold; text-align: center;';
        name.textContent = skin.name;
        
        const equipBtn = document.createElement('button');
        equipBtn.style.cssText = `
          width: 100%;
          padding: 8px;
          margin-top: 10px;
          border: none;
          border-radius: 5px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s;
        `;
        
        if (skinId === equippedSkin) {
          equipBtn.textContent = '‚úì Equipped';
          equipBtn.style.background = '#28a745';
          equipBtn.style.color = 'white';
          equipBtn.disabled = true;
        } else {
          equipBtn.textContent = 'Equip';
          equipBtn.style.background = '#667eea';
          equipBtn.style.color = 'white';
          equipBtn.onclick = () => equipSkin(skinId);
          equipBtn.onmouseenter = () => equipBtn.style.background = '#5568d3';
          equipBtn.onmouseleave = () => equipBtn.style.background = '#667eea';
        }
        
        card.appendChild(preview);
        card.appendChild(name);
        card.appendChild(equipBtn);
        skinsGrid.appendChild(card);
      });
    }
    
    async function equipSkin(skinId) {
      if (!currentUser) return;
      
      try {
        // Update locally
        currentUser.inventory.equippedSkin = skinId;
        selectedSkin = skinId;
        
        // Save to server
        if (!isGuest) {
          const res = await fetch('/api/auth/profile', {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${authToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              inventory: {
                equippedSkin: skinId
              }
            })
          });
          
          if (!res.ok) {
            console.error('Failed to save equipped skin');
          }
        }
        
        // Reload locker to show new equipped state
        loadLockerItems();
        updateLockerPreview();
        
        // Show feedback
        const btn = event.currentTarget;
        const originalText = btn.textContent;
        btn.textContent = '‚úì Equipped!';
        btn.style.background = '#28a745';
        setTimeout(() => {
          loadLockerItems();
        }, 500);
        
      } catch (error) {
        console.error('Equip error:', error);
        alert('Failed to equip skin');
      }
    }
    
    function updateLockerPreview() {
      if (!currentUser || !currentUser.inventory) return;
      
      const equippedSkin = currentUser.inventory.equippedSkin || 'default';
      const skin = CharacterRenderer.skins[equippedSkin];
      
      // Update preview canvas
      const canvas = document.getElementById('locker-preview');
      if (canvas) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();
        ctx.translate(60, 60);
        try {
          CharacterRenderer.render(ctx, equippedSkin, 40);
        } catch (e) {
          console.error('Preview render error:', e);
        }
        ctx.restore();
      }
      
      // Update skin name
      const nameEl = document.getElementById('locker-skin-name');
      if (nameEl && skin) {
        nameEl.textContent = skin.name;
      }
      
      // Update equipped display
      const displayEl = document.getElementById('equipped-skin-display');
      if (displayEl && skin) {
        displayEl.textContent = skin.name;
      }
    }
    
    async function switchShopTab(tab) {
      // Update active tab
      document.querySelectorAll('.shop-tab').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
      
      currentShopTab = tab;
      await loadShopItems(tab);
    }
    
    async function loadShopItems(category) {
      const content = document.getElementById('shop-content');
      content.innerHTML = '<p style="text-align: center;">Loading...</p>';
      
      try {
        let items = [];
        
        if (category === 'bundles') {
          const res = await fetch('/api/shop/bundles', {
            headers: { 'Authorization': `Bearer ${authToken}` }
          });
          const data = await res.json();
          content.innerHTML = renderBundles(data);
          return;
        } else {
          // Load all items and filter by category
          const res = await fetch('/api/shop/items', {
            headers: { 'Authorization': `Bearer ${authToken}` }
          });
          const allItems = await res.json();
          
          // Map category names to item types
          const typeMap = {
            'skins': 'skin',
            'emotes': 'emote',
            'trails': 'trail',
            'weapon_skins': 'weapon_skin'
          };
          
          const itemType = typeMap[category];
          items = allItems.filter(item => item.type === itemType);
          
          console.log(`Category: ${category}, Type: ${itemType}, Items found:`, items.length);
        }
        
        content.innerHTML = renderShopItems(items, category);
      } catch (error) {
        console.error('Load shop error:', error);
        content.innerHTML = '<p style="text-align: center; color: red;">Error loading shop</p>';
      }
    }
    
    function renderShopItems(items, category) {
      if (items.length === 0) {
        return '<p style="text-align: center; color: #666;">No items available in this category</p>';
      }
      
      return `
        <div class="shop-grid">
          ${items.map(item => `
            <div class="shop-item ${item.owned ? 'owned' : ''}">
              <div class="shop-item-icon">${getItemIcon(item.type, item)}</div>
              <div class="shop-item-name">${item.name}</div>
              <div class="shop-item-rarity rarity-${item.rarity || 'common'}">${(item.rarity || 'common').toUpperCase()}</div>
              <div class="shop-item-price">üí∞ ${item.price}</div>
              ${item.owned 
                ? '<div class="shop-owned-badge">‚úÖ Owned</div>'
                : `<button class="shop-buy-btn" onclick="buyItem('${item.id}', '${item.type}', ${item.price})">Buy Now</button>`
              }
            </div>
          `).join('')}
        </div>
      `;
    }
    
    function renderBundles(bundles) {
      if (!bundles || bundles.length === 0) {
        return '<p style="text-align: center; color: #666;">No bundles available</p>';
      }
      
      return bundles.map(bundle => `
        <div class="bundle-card">
          <h3 style="margin-bottom: 10px;">${bundle.name}</h3>
          <p style="opacity: 0.9; margin-bottom: 15px;">${bundle.description || ''}</p>
          
          <div class="bundle-items">
            ${bundle.items.map(item => `
              <div class="bundle-item-icon" title="${item.name}">${getItemIcon(item.type)}</div>
            `).join('')}
          </div>
          
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
            <div>
              <span style="font-size: 24px; font-weight: bold;">üí∞ ${bundle.price}</span>
              ${bundle.originalPrice ? `<span style="text-decoration: line-through; opacity: 0.7; margin-left: 10px;">${bundle.originalPrice}</span>` : ''}
              ${bundle.discount ? `<span style="background: #e74c3c; padding: 4px 8px; border-radius: 5px; margin-left: 10px; font-size: 14px;">${bundle.discount}% OFF</span>` : ''}
            </div>
            ${bundle.allOwned 
              ? '<span style="background: #2ecc71; padding: 10px 20px; border-radius: 10px;">‚úÖ All Owned</span>'
              : `<button class="shop-buy-btn" style="padding: 15px 30px; font-size: 16px;" onclick="buyBundle('${bundle.id}', ${bundle.price})">Buy Bundle</button>`
            }
          </div>
        </div>
      `).join('');
    }
    
    function getItemIcon(type, item) {
      const icons = {
        skin: 'ü§ñ',
        emote: 'üòä',
        trail: '‚ú®',
        weapon_skin: 'üî´'
      };
      
      // For weapon skins, could show specific weapon icons
      if (type === 'weapon_skin' && item && item.weapon) {
        const weaponIcons = {
          pistol: 'üî´',
          rifle: 'üéØ',
          shotgun: 'üí•',
          sniper: 'üéØ',
          smg: '‚ö°',
          rocket_launcher: 'üöÄ'
        };
        return weaponIcons[item.weapon] || 'üî´';
      }
      
      return icons[type] || 'üéÅ';
    }
    
    async function buyItem(itemId, itemType, price) {
      if (currentUser.stats.coins < price) {
        alert('‚ùå Not enough coins!');
        return;
      }
      
      if (!confirm(`Buy this item for ${price} coins?`)) {
        return;
      }
      
      try {
        const res = await fetch('/api/shop/purchase', {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ itemId, itemType })
        });
        
        const data = await res.json();
        
        if (res.ok) {
          alert('‚úÖ Purchase successful!');
          currentUser.stats.coins = data.newBalance;
          document.getElementById('shop-coins-display').textContent = data.newBalance;
          document.getElementById('coins-header').textContent = data.newBalance;
          document.getElementById('coins-display').textContent = data.newBalance;
          await loadShopItems(currentShopTab);
        } else {
          alert('‚ùå ' + (data.error || 'Purchase failed'));
        }
      } catch (error) {
        console.error('Purchase error:', error);
        alert('‚ùå Error purchasing item');
      }
    }
    
    async function buyBundle(bundleId, price) {
      if (currentUser.stats.coins < price) {
        alert('‚ùå Not enough coins!');
        return;
      }
      
      if (!confirm(`Buy this bundle for ${price} coins?`)) {
        return;
      }
      
      try {
        const res = await fetch('/api/shop/purchase-bundle', {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ bundleId })
        });
        
        const data = await res.json();
        
        if (res.ok) {
          alert('‚úÖ Bundle purchased!');
          currentUser.stats.coins = data.newBalance;
          document.getElementById('shop-coins-display').textContent = data.newBalance;
          document.getElementById('coins-header').textContent = data.newBalance;
          document.getElementById('coins-display').textContent = data.newBalance;
          await loadShopItems('bundles');
        } else {
          alert('‚ùå ' + (data.error || 'Purchase failed'));
        }
      } catch (error) {
        console.error('Bundle purchase error:', error);
        alert('‚ùå Error purchasing bundle');
      }
    }

    // ========== GAME VARIABLES ==========
    let canvas, ctx;
    let gameState = null;
    let myPlayer = null;
    let players = [];
    let keys = {};
    let mouseX = 0, mouseY = 0;
    let mouseWorldX = 0, mouseWorldY = 0;
    let camera = { x: 0, y: 0 };
    
    // Resize canvas when window resizes
    window.addEventListener('resize', () => {
      if (canvas) {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
    });
    
    // ========== GAME INITIALIZATION ==========
    let game3D = null; // Global 3D game instance
    
    function initGame(data) {
      console.log('üéÆ Initializing game...', data);
      
      // HIDE ALL MENU SCREENS!
      document.getElementById('menu-screen').style.display = 'none';
      document.getElementById('lobby-screen').style.display = 'none';
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('game-screen').style.display = 'none'; // Hide 2D canvas too
      
      console.log('üôà All menu screens hidden');
      
      // Store game state
      gameState = data;
      gameState.bullets = gameState.bullets || [];
      gameState.buildings = gameState.buildings || [];
      gameState.chests = gameState.chests || [];
      
      // Initialize SIMPLE 3D Engine
      if (typeof THREE !== 'undefined' && typeof Pixelio3D !== 'undefined') {
        try {
          game3D = new Pixelio3D();
          game3D.setMyPlayer(socket.id);
          game3D.createBuildings(gameState.buildings, gameState.map.size);
          console.log('‚úÖ Simple 3D Engine started!');
          
          // Send inputs to server
          setInterval(() => {
            if (game3D) {
              game3D.sendInputs(socket);
            }
          }, 1000/60); // 60 FPS
          
        } catch (error) {
          console.error('‚ùå 3D Error:', error);
          alert('3D Error: ' + error.message);
        }
      } else {
        console.error('‚ùå THREE or Pixelio3D not loaded!');
        alert('THREE or Pixelio3D not loaded! Check console.');
      }
      
      console.log(`üìç Map size: ${gameState.map.size}`);
      console.log(`üè† Buildings: ${gameState.buildings.length}`);
      console.log(`üì¶ Chests: ${gameState.chests.length}`);
    }
    
    // Prevent duplicate event listeners
    let controlsSetup = false;
    
    function setupGameControls() {
      if (controlsSetup) return;
      controlsSetup = true;
      console.log('üéÆ Controls setup');
      
      // Keyboard controls
      window.addEventListener('keydown', (e) => {
        keys[e.key.toLowerCase()] = true;
        if (['w','a','s','d'].includes(e.key.toLowerCase())) {
          console.log('üîë', e.key);
        }
        
        // E key interactions
        if (e.key.toLowerCase() === 'e') {
          // Open chests
          if (window.nearbyChestId) {
            socket.emit('open-chest', { chestId: window.nearbyChestId });
            window.nearbyChestId = null;
          }
          // Open/close doors
          else if (window.nearbyDoorId) {
            socket.emit('toggle-door', { doorId: window.nearbyDoorId });
          }
          // Go down stairs
          else if (window.nearbyStairs) {
            socket.emit('use-stairs', { direction: -1 }); // Down
          }
        }
        
        // Q key to go up stairs
        if (e.key.toLowerCase() === 'q' && window.nearbyStairs) {
          socket.emit('use-stairs', { direction: 1 }); // Up
        }
      });
      
      window.addEventListener('keyup', (e) => {
        keys[e.key.toLowerCase()] = false;
      });
      
      // Mouse controls
      canvas.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        mouseX = e.clientX - rect.left;
        mouseY = e.clientY - rect.top;
        mouseWorldX = mouseX + camera.x;
        mouseWorldY = mouseY + camera.y;
      });
      
      canvas.addEventListener('click', (e) => {
        // Shoot
        socket.emit('player-shoot', {
          targetX: mouseWorldX,
          targetY: mouseWorldY
        });
      });
    }
    
    function sendInputs() {
      if (!socket || !gameState) return;
      
      const moving = keys['w'] || keys['s'] || keys['a'] || keys['d'];
      if (moving && Math.random() < 0.1) console.log('üì° Moving');
      
      // Send current input state to server
      socket.emit('player-input', {
        up: keys['w'] || false,
        down: keys['s'] || false,
        left: keys['a'] || false,
        right: keys['d'] || false,
        mouseX: mouseWorldX,
        mouseY: mouseWorldY
      });
    }
    
    // ========== GAME LOOP ==========
    function gameLoop() {
      if (!canvas || !ctx) return;
      
      // Clear canvas with gradient sky
      const skyGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
      skyGradient.addColorStop(0, '#87CEEB');
      skyGradient.addColorStop(1, '#E0F6FF');
      ctx.fillStyle = skyGradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Draw game elements (order matters for layering!)
      if (gameState) {
        drawGround();
        drawPOILabels(); // POI names like Fortnite!
        drawBuildings(); // Buildings first
        drawChests(); // Chests on buildings
        drawStorm();
        drawTriviaStations();
        drawPowerups();
        drawWeapons();
        drawVehicles();
        drawBullets();
        drawPlayers(); // Players on top
        drawUI();
        checkChestProximity(); // Check if near chest
      }
      
      // Continue loop
      requestAnimationFrame(gameLoop);
    }
    
    function drawChests() {
      if (!gameState || !gameState.chests) return;
      
      try {
        gameState.chests.forEach(chest => {
          if (chest.opened) return; // Don't draw opened chests
          
          const x = chest.x - camera.x;
          const y = chest.y - camera.y;
          const size = 40;
          
          // Chest glow based on rarity
          const glowColors = {
            common: 'rgba(150, 150, 150, 0.3)',
            rare: 'rgba(0, 112, 221, 0.4)',
            epic: 'rgba(163, 53, 238, 0.5)',
            legendary: 'rgba(255, 184, 0, 0.6)'
          };
          
          const chestColors = {
            common: { main: '#8B4513', accent: '#A0522D' },
            rare: { main: '#0070DD', accent: '#4A9EFF' },
            epic: { main: '#A335EE', accent: '#C864FF' },
            legendary: { main: '#FFB800', accent: '#FFD700' }
          };
          
          const glow = glowColors[chest.type] || glowColors.common;
          const colors = chestColors[chest.type] || chestColors.common;
          
          // Animated glow
          const pulseSize = 60 + Math.sin(Date.now() / 300) * 10;
          const glowGradient = ctx.createRadialGradient(x, y, 10, x, y, pulseSize);
          glowGradient.addColorStop(0, glow);
          glowGradient.addColorStop(1, 'rgba(0,0,0,0)');
          ctx.fillStyle = glowGradient;
          ctx.fillRect(x - pulseSize, y - pulseSize, pulseSize * 2, pulseSize * 2);
          
          // Shadow
          ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
          ctx.fillRect(x - size/2 + 3, y + size/2 + 3, size, size/4);
          
          // Chest body
          const bodyGradient = ctx.createLinearGradient(x - size/2, y - size/2, x + size/2, y + size/2);
          bodyGradient.addColorStop(0, colors.main);
          bodyGradient.addColorStop(1, colors.accent);
          ctx.fillStyle = bodyGradient;
          ctx.fillRect(x - size/2, y - size/3, size, size * 0.7);
          
          // Chest lid
          ctx.fillStyle = colors.accent;
          ctx.fillRect(x - size/2, y - size/2, size, size/4);
          
          // Gold latch
          ctx.fillStyle = '#FFD700';
          ctx.fillRect(x - 5, y - size/6, 10, 15);
          
          // Border
          ctx.strokeStyle = '#000';
          ctx.lineWidth = 2;
          ctx.strokeRect(x - size/2, y - size/2, size, size * 0.7);
          
          // Rarity indicator
          if (chest.type !== 'common') {
            ctx.fillStyle = '#FFF';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(chest.type.toUpperCase(), x, y + size/2 + 20);
          }
        });
      } catch (error) {
        console.error('Error drawing chests:', error);
      }
    }
    
    function checkChestProximity() {
      if (!gameState || !gameState.chests || !players) return;
      
      const localPlayer = players.find(p => p.id === socket.id);
      if (!localPlayer || !localPlayer.isAlive) return;
      
      // Find nearby unopened chests
      const nearbyChest = gameState.chests.find(chest => {
        if (chest.opened) return false;
        const dist = Math.sqrt(
          (localPlayer.x - chest.x) ** 2 + 
          (localPlayer.y - chest.y) ** 2
        );
        return dist < 100; // Within 100 units
      });
      
      // Show prompt if near chest
      if (nearbyChest) {
        ctx.save();
        const x = nearbyChest.x - camera.x;
        const y = nearbyChest.y - camera.y - 50;
        
        // Prompt background
        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        ctx.fillRect(x - 60, y - 15, 120, 30);
        
        // Prompt text
        ctx.fillStyle = '#FFF';
        ctx.font = 'bold 14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Press E to Open', x, y + 5);
        
        ctx.restore();
        
        // Store for key handler
        window.nearbyChestId = nearbyChest.id;
      } else {
        window.nearbyChestId = null;
      }
    }
    
    function drawBuildings() {
      if (!gameState || !gameState.buildings) return;
      
      try {
        gameState.buildings.forEach(building => {
          const x = building.x - camera.x;
          const y = building.y - camera.y;
          const w = building.width || 70;
          const h = building.height || 70;
          
          // Only draw if on screen (optimization)
          if (x + w < 0 || x > canvas.width || y + h < 0 || y > canvas.height) {
            return;
          }
          
          // Check if player is inside this building
          const player = gameState.players?.find(p => p.id === socket.id);
          const playerFloor = player?.floor || 0;
          const playerInside = player && 
            player.x >= building.x && player.x <= building.x + w &&
            player.y >= building.y && player.y <= building.y + h;
          
          // === BUILDING FOUNDATION/SHADOW ===
          ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
          ctx.fillRect(x + 6, y + 6, w, h);
          
          // === MAIN BUILDING STRUCTURE ===
          // POLYTORIA STYLE - BRIGHT COLORFUL BUILDINGS! üé®
          let buildingColor = '#FF69B4'; // Default pink!
          if (building.name?.includes('Shop')) buildingColor = '#87CEEB'; // Sky blue
          else if (building.name?.includes('Tower')) buildingColor = '#9370DB'; // Purple
          else if (building.name?.includes('Warehouse')) buildingColor = '#FFD700'; // Gold
          else if (building.name?.includes('Restaurant')) buildingColor = '#FF6347'; // Tomato red
          else if (building.name?.includes('Apartment')) buildingColor = '#FFD54F'; // Yellow
          else if (building.name?.includes('House')) buildingColor = '#98FB98'; // Pale green
          
          // Bright gradient for 3D effect
          const gradient = ctx.createLinearGradient(x, y, x, y + h);
          gradient.addColorStop(0, lightenColor(buildingColor, 1.2));
          gradient.addColorStop(0.5, buildingColor);
          gradient.addColorStop(1, darkenColor(buildingColor, 0.8));
          
          ctx.fillStyle = gradient;
          ctx.fillRect(x, y, w, h);
          
          // Thick black outline (Polytoria style!)
          ctx.strokeStyle = '#000';
          ctx.lineWidth = 4;
          ctx.strokeRect(x, y, w, h);
          
          // === DRAW ROOMS (if player is inside or nearby) ===
          if (playerInside || (player && distance(player.x, player.y, building.x + w/2, building.y + h/2) < 200)) {
            if (building.rooms) {
              ctx.save();
              ctx.globalAlpha = playerInside ? 1.0 : 0.5;
              
              building.rooms.forEach(room => {
                // Only show rooms on current floor if player is inside
                if (playerInside && room.floor !== playerFloor) return;
                
                const rx = x + room.x;
                const ry = y + room.y;
                
                // Room floor
                ctx.fillStyle = '#F5F5DC';
                ctx.fillRect(rx, ry, room.width, room.height);
                
                // Room walls (interior)
                ctx.strokeStyle = '#8B4513';
                ctx.lineWidth = 2;
                ctx.strokeRect(rx, ry, room.width, room.height);
                
                // Room name label
                if (playerInside && room.name) {
                  ctx.fillStyle = '#333';
                  ctx.font = 'bold 11px Arial';
                  ctx.textAlign = 'center';
                  ctx.fillText(room.name, rx + room.width/2, ry + room.height/2);
                }
              });
              
              ctx.restore();
            }
          }
          
          // === DRAW DOORS ===
          if (building.doors) {
            building.doors.forEach(door => {
              // Only show doors on current floor if player is inside
              if (playerInside && door.floor !== playerFloor) return;
              
              const dx = x + door.x;
              const dy = y + door.y;
              
              if (door.open) {
                // Open door (dark opening)
                ctx.fillStyle = '#000';
                ctx.fillRect(dx, dy, door.width, 8);
                ctx.strokeStyle = '#555';
                ctx.lineWidth = 2;
                ctx.strokeRect(dx, dy, door.width, 8);
              } else {
                // Closed door (brown)
                ctx.fillStyle = '#654321';
                ctx.fillRect(dx, dy, door.width, 8);
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.strokeRect(dx, dy, door.width, 8);
                
                // Door handle
                ctx.fillStyle = '#FFD700';
                ctx.beginPath();
                ctx.arc(dx + door.width - 5, dy + 4, 2, 0, Math.PI * 2);
                ctx.fill();
              }
              
              // Door interaction hint
              if (player && distance(player.x, player.y, building.x + door.x, building.y + door.y) < 50) {
                ctx.fillStyle = '#FFF';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Press E', dx + door.width/2, dy - 10);
                
                // Store for key handler
                window.nearbyDoorId = door.id;
              }
            });
          }
          
          // === RESET nearby door if no door is close ===
          if (building.doors && player) {
            const anyDoorNearby = building.doors.some(door => 
              distance(player.x, player.y, building.x + door.x, building.y + door.y) < 50
            );
            if (!anyDoorNearby) {
              window.nearbyDoorId = null;
            }
          }
          
          // === DRAW WINDOWS ===
          if (building.windows) {
            building.windows.forEach(window => {
              // Only show windows on current/visible floors
              if (playerInside && window.floor !== playerFloor) return;
              
              const wx = x + window.x;
              const wy = y + window.y;
              const size = window.size || 20;
              
              // Window glass with reflection
              const windowGradient = ctx.createLinearGradient(wx, wy, wx + size, wy + size);
              windowGradient.addColorStop(0, 'rgba(135, 206, 250, 0.6)');
              windowGradient.addColorStop(1, 'rgba(100, 149, 237, 0.8)');
              
              ctx.fillStyle = windowGradient;
              ctx.fillRect(wx, wy, size, size);
              
              // Window frame
              ctx.strokeStyle = '#333';
              ctx.lineWidth = 2;
              ctx.strokeRect(wx, wy, size, size);
              
              // Window cross divider
              ctx.beginPath();
              ctx.moveTo(wx + size/2, wy);
              ctx.lineTo(wx + size/2, wy + size);
              ctx.moveTo(wx, wy + size/2);
              ctx.lineTo(wx + size, wy + size/2);
              ctx.stroke();
              
              // Window shine
              ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
              ctx.fillRect(wx + 2, wy + 2, size/3, size/3);
            });
          }
          
          // === DRAW STAIRS ===
          if (building.stairs && playerInside) {
            building.stairs.forEach(stair => {
              if (stair.floor !== playerFloor) return;
              
              const sx = x + stair.x;
              const sy = y + stair.y;
              
              // Staircase
              ctx.fillStyle = '#8B7355';
              ctx.fillRect(sx, sy, stair.width, stair.height);
              
              // Stair steps
              ctx.strokeStyle = '#654321';
              ctx.lineWidth = 1;
              const numSteps = 8;
              for (let i = 0; i < numSteps; i++) {
                const stepY = sy + (stair.height / numSteps) * i;
                ctx.beginPath();
                ctx.moveTo(sx, stepY);
                ctx.lineTo(sx + stair.width, stepY);
                ctx.stroke();
              }
              
              // Stair interaction hint
              if (player && distance(player.x, player.y, building.x + stair.x, building.y + stair.y) < 40) {
                ctx.fillStyle = '#FFF';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('‚¨ÜÔ∏è Q: Up  ‚¨áÔ∏è E: Down', sx + stair.width/2, sy - 10);
                
                // Store for key handler
                window.nearbyStairs = true;
              }
            });
            
            // Reset if no stairs nearby
            if (player) {
              const anyStairsNearby = building.stairs.some(stair => 
                distance(player.x, player.y, building.x + stair.x, building.y + stair.y) < 40
              );
              if (!anyStairsNearby) {
                window.nearbyStairs = false;
              }
            }
          }
          
          // === ROOF (only if player not inside or on top floor) ===
          if (!playerInside || (building.floors && playerFloor >= building.floors - 1)) {
            // Roof with gradient
            const roofGradient = ctx.createLinearGradient(x, y - 20, x, y);
            roofGradient.addColorStop(0, darkenColor(buildingColor, 0.5));
            roofGradient.addColorStop(1, darkenColor(buildingColor, 0.7));
            
            ctx.fillStyle = roofGradient;
            ctx.beginPath();
            ctx.moveTo(x - 10, y);
            ctx.lineTo(x + w/2, y - 20);
            ctx.lineTo(x + w + 10, y);
            ctx.closePath();
            ctx.fill();
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.stroke();
          }
          
          // === BUILDING NAME LABEL ===
          if (building.name) {
            ctx.fillStyle = '#FFF';
            ctx.strokeStyle = '#000';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.lineWidth = 3;
            ctx.strokeText(building.name, x + w/2, y - 30);
            ctx.fillText(building.name, x + w/2, y - 30);
          }
          
          // === FLOOR INDICATOR (if multi-floor and player inside) ===
          if (playerInside && building.floors && building.floors > 1) {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(x + 5, y + 5, 80, 25);
            ctx.fillStyle = '#FFF';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`Floor ${playerFloor + 1}/${building.floors}`, x + 10, y + 20);
          }
          
          // === HEALTH BAR (if damaged) ===
          if (building.health < building.maxHealth) {
            const barWidth = w;
            const barHeight = 6;
            const healthPercent = building.health / building.maxHealth;
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(x, y - 12, barWidth, barHeight);
            
            ctx.fillStyle = healthPercent > 0.66 ? '#2ecc71' : 
                           healthPercent > 0.33 ? '#f39c12' : '#e74c3c';
            ctx.fillRect(x, y - 12, barWidth * healthPercent, barHeight);
            
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 1;
            ctx.strokeRect(x, y - 12, barWidth, barHeight);
          }
        });
      } catch (error) {
        console.error('Building render error:', error);
      }
    }
    
    // Helper function to darken colors
    function darkenColor(color, factor) {
      const hex = color.replace('#', '');
      const r = Math.floor(parseInt(hex.substr(0, 2), 16) * factor);
      const g = Math.floor(parseInt(hex.substr(2, 2), 16) * factor);
      const b = Math.floor(parseInt(hex.substr(4, 2), 16) * factor);
      return `rgb(${r}, ${g}, ${b})`;
    }
    
    function lightenColor(color, factor) {
      const hex = color.replace('#', '');
      const r = Math.min(255, Math.floor(parseInt(hex.substr(0, 2), 16) * factor));
      const g = Math.min(255, Math.floor(parseInt(hex.substr(2, 2), 16) * factor));
      const b = Math.min(255, Math.floor(parseInt(hex.substr(4, 2), 16) * factor));
      return `rgb(${r}, ${g}, ${b})`;
    }
    
    // Helper function for distance calculation
    function distance(x1, y1, x2, y2) {
      return Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
    }
    
    function drawGround() {
      if (!gameState) return;
      
      const mapSize = gameState.map.size;
      
      // POLYTORIA STYLE - BRIGHT LIME GREEN GRASS! üåà
      const grassGradient = ctx.createLinearGradient(0, 0, mapSize, mapSize);
      grassGradient.addColorStop(0, '#7FFF00'); // Bright lime
      grassGradient.addColorStop(0.5, '#32CD32'); // Lime green
      grassGradient.addColorStop(1, '#00FF00'); // Pure green
      ctx.fillStyle = grassGradient;
      ctx.fillRect(-camera.x, -camera.y, mapSize, mapSize);
      
      // Colorful patches (Polytoria style!)
      const patchSize = 100;
      const colors = ['#FFD700', '#FF69B4', '#87CEEB', '#FF6347', '#9370DB', '#00FA9A'];
      
      for (let x = 0; x < mapSize; x += patchSize*2) {
        for (let y = 0; y < mapSize; y += patchSize*2) {
          const px = x - camera.x;
          const py = y - camera.y;
          
          // Only draw visible patches
          if (px > -patchSize && px < canvas.width + patchSize &&
              py > -patchSize && py < canvas.height + patchSize) {
            const seed = Math.floor((x + y) / 100);
            if (seed % 5 === 0) {
              ctx.fillStyle = colors[seed % colors.length];
              ctx.globalAlpha = 0.15;
              ctx.beginPath();
              ctx.arc(px + patchSize/2, py + patchSize/2, patchSize*0.4, 0, Math.PI*2);
              ctx.fill();
              ctx.globalAlpha = 1;
            }
          }
        }
      }
      
      // Fun decorative trees (simple blocky style!)
      const treeCount = 60;
      for (let i = 0; i < treeCount; i++) {
        const seed = i * 12345;
        const treeX = (seed * 9301 + 49297) % mapSize;
        const treeY = (seed * 9283 + 48271) % mapSize;
        const px = treeX - camera.x;
        const py = treeY - camera.y;
        
        if (px > -50 && px < canvas.width + 50 && py > -50 && py < canvas.height + 50) {
          // Blocky tree!
          ctx.fillStyle = '#8B4513'; // Brown trunk
          ctx.fillRect(px-5, py-10, 10, 25);
          
          ctx.fillStyle = '#228B22'; // Green leaves
          ctx.beginPath();
          ctx.arc(px, py-20, 20, 0, Math.PI*2);
          ctx.fill();
          
          ctx.strokeStyle = '#000';
          ctx.lineWidth = 2;
          ctx.stroke();
        }
      }
      
      // Colorful rocks/decorations
      const rockCount = 40;
      const rockColors = ['#FFD700', '#FF69B4', '#87CEEB', '#FF6347'];
      for (let i = 0; i < rockCount; i++) {
        const seed = i * 54321;
        const rockX = (seed * 9301 + 49297) % mapSize;
        const rockY = (seed * 9283 + 48271) % mapSize;
        const px = rockX - camera.x;
        const py = rockY - camera.y;
        
        if (px > -30 && px < canvas.width + 30 && py > -30 && py < canvas.height + 30) {
          drawRock(px, py);
        }
      }
      
      // Border
      ctx.strokeStyle = '#3D7A2C';
      ctx.lineWidth = 10;
      ctx.strokeRect(-camera.x, -camera.y, mapSize, mapSize);
    }
    
    function drawTree(x, y) {
      // Trunk
      ctx.fillStyle = '#8B4513';
      ctx.fillRect(x - 4, y, 8, 22);
      
      // Foliage layers
      ctx.fillStyle = '#2D5016';
      ctx.beginPath();
      ctx.arc(x, y - 5, 16, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.fillStyle = '#3A6B1F';
      ctx.beginPath();
      ctx.arc(x - 9, y, 13, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.beginPath();
      ctx.arc(x + 9, y, 13, 0, Math.PI * 2);
      ctx.fill();
      
      // Highlight
      ctx.fillStyle = '#4D8028';
      ctx.beginPath();
      ctx.arc(x - 4, y - 8, 6, 0, Math.PI * 2);
      ctx.fill();
    }
    
    function drawRock(x, y) {
      // Shadow
      ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
      ctx.beginPath();
      ctx.ellipse(x, y + 12, 18, 6, 0, 0, Math.PI * 2);
      ctx.fill();
      
      // Rock
      ctx.fillStyle = '#7A7A7A';
      ctx.beginPath();
      ctx.ellipse(x, y, 16, 12, 0, 0, Math.PI * 2);
      ctx.fill();
      
      // Highlight
      ctx.fillStyle = '#999';
      ctx.beginPath();
      ctx.ellipse(x - 4, y - 4, 6, 4, 0, 0, Math.PI * 2);
      ctx.fill();
      
      // Dark edge
      ctx.fillStyle = '#555';
      ctx.beginPath();
      ctx.ellipse(x + 5, y + 5, 4, 3, 0, 0, Math.PI * 2);
      ctx.fill();
    }
    
    function drawPOILabels() {
      if (!gameState || !gameState.map) return;
      
      // Check if POIs exist and is an array
      if (!gameState.map.pois || !Array.isArray(gameState.map.pois)) {
        return; // No POIs to draw
      }
      
      try {
        gameState.map.pois.forEach(poi => {
          // Validate POI data
          if (!poi || typeof poi.x !== 'number' || typeof poi.y !== 'number') {
            console.warn('Invalid POI data:', poi);
            return;
          }
          
          const x = poi.x - camera.x;
          const y = poi.y - camera.y;
          
          // Only draw if POI center is roughly on screen
          if (x < -300 || x > canvas.width + 300 || y < -300 || y > canvas.height + 300) return;
          
          const poiSize = poi.size || 300; // Default size if missing
          
          // POI area circle (subtle)
          ctx.strokeStyle = 'rgba(255, 255, 255, 0.15)';
          ctx.lineWidth = 3;
          ctx.setLineDash([15, 15]);
          ctx.beginPath();
          ctx.arc(x, y, poiSize / 2, 0, Math.PI * 2);
          ctx.stroke();
          ctx.setLineDash([]);
          
          // POI name (Fortnite style!)
          ctx.save();
          
          // Shadow
          ctx.font = 'bold 30px Arial';
          ctx.textAlign = 'center';
          ctx.strokeStyle = '#000';
          ctx.lineWidth = 8;
          const poiName = poi.name || 'Unknown Location';
          ctx.strokeText(poiName, x, y - poiSize/2 - 40);
          
          // White text
          ctx.fillStyle = '#FFF';
          ctx.shadowColor = '#000';
          ctx.shadowBlur = 10;
          ctx.fillText(poiName, x, y - poiSize/2 - 40);
          ctx.shadowBlur = 0;
          
          // Icon
          const icons = {
            urban: 'üèòÔ∏è', mall: 'üè¨', castle: 'üè∞',
            park: 'üå≥', forest: 'üå≤', military: '‚öîÔ∏è', island: 'üèùÔ∏è'
          };
          const icon = icons[poi.type] || 'üìç';
          
          ctx.font = '36px Arial';
          ctx.strokeStyle = '#000';
          ctx.lineWidth = 4;
          ctx.strokeText(icon, x, y - poiSize/2 - 75);
          ctx.fillText(icon, x, y - poiSize/2 - 75);
          
          ctx.restore();
        });
      } catch (error) {
        console.error('Error drawing POI labels:', error);
      }
    }
    
    function drawStorm() {
      if (!gameState || !gameState.stormRadius) return;
      
      // Draw storm with glow effect
      ctx.save();
      
      // Outer glow
      for (let i = 3; i > 0; i--) {
        ctx.strokeStyle = `rgba(139, 0, 255, ${0.1 * i})`;
        ctx.lineWidth = 15 * i;
        ctx.beginPath();
        ctx.arc(
          gameState.stormCenter.x - camera.x,
          gameState.stormCenter.y - camera.y,
          gameState.stormRadius + (10 * i),
          0,
          Math.PI * 2
        );
        ctx.stroke();
      }
      
      // Main storm line
      ctx.strokeStyle = '#9D00FF';
      ctx.lineWidth = 5;
      ctx.setLineDash([15, 10]);
      ctx.beginPath();
      ctx.arc(
        gameState.stormCenter.x - camera.x,
        gameState.stormCenter.y - camera.y,
        gameState.stormRadius,
        0,
        Math.PI * 2
      );
      ctx.stroke();
      ctx.setLineDash([]);
      
      ctx.restore();
    }
    
    function drawTriviaStations() {
      if (!gameState || !gameState.triviaStations) return;
      
      gameState.triviaStations.forEach(station => {
        if (station.answered) return;
        
        const x = station.x - camera.x;
        const y = station.y - camera.y;
        
        // Glow effect
        const gradient = ctx.createRadialGradient(x, y, 5, x, y, 30);
        gradient.addColorStop(0, 'rgba(255, 215, 0, 0.8)');
        gradient.addColorStop(1, 'rgba(255, 215, 0, 0)');
        ctx.fillStyle = gradient;
        ctx.fillRect(x - 30, y - 30, 60, 60);
        
        // Main circle
        ctx.fillStyle = '#FFD700';
        ctx.shadowColor = '#FFA500';
        ctx.shadowBlur = 20;
        ctx.beginPath();
        ctx.arc(x, y, 25, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;
        
        // Border
        ctx.strokeStyle = '#FFA500';
        ctx.lineWidth = 4;
        ctx.stroke();
        
        // "?" symbol
        ctx.fillStyle = '#000';
        ctx.font = 'bold 30px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('?', x, y);
      });
    }
    
    function drawPowerups() {
      if (!gameState || !gameState.powerups) return;
      
      gameState.powerups.forEach(powerup => {
        if (powerup.collected) return;
        
        const x = powerup.x - camera.x;
        const y = powerup.y - camera.y;
        
        const colors = {
          health: { main: '#FF3B3B', glow: '#FF6B6B' },
          shield: '#00BFFF',
          speed: { main: '#FFD700', glow: '#FFED4E' },
          damage: { main: '#FF4500', glow: '#FF6347' },
          invincibility: { main: '#9370DB', glow: '#BA55D3' }
        };
        
        const color = colors[powerup.type] || { main: '#FFF', glow: '#FFF' };
        const mainColor = color.main || color;
        const glowColor = color.glow || color;
        
        // Glow
        const gradient = ctx.createRadialGradient(x, y, 5, x, y, 25);
        gradient.addColorStop(0, glowColor);
        gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
        ctx.fillStyle = gradient;
        ctx.fillRect(x - 25, y - 25, 50, 50);
        
        // Main circle
        ctx.fillStyle = mainColor;
        ctx.shadowColor = glowColor;
        ctx.shadowBlur = 15;
        ctx.beginPath();
        ctx.arc(x, y, 18, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;
        
        ctx.strokeStyle = '#FFF';
        ctx.lineWidth = 3;
        ctx.stroke();
      });
    }
    
    function drawWeapons() {
      if (!gameState || !gameState.weaponSpawns) return;
      
      gameState.weaponSpawns.forEach(weapon => {
        if (weapon.collected) return;
        
        const x = weapon.x - camera.x;
        const y = weapon.y - camera.y;
        
        // Glow
        const gradient = ctx.createRadialGradient(x, y, 5, x, y, 30);
        gradient.addColorStop(0, 'rgba(192, 192, 192, 0.6)');
        gradient.addColorStop(1, 'rgba(192, 192, 192, 0)');
        ctx.fillStyle = gradient;
        ctx.fillRect(x - 30, y - 30, 60, 60);
        
        // Weapon box with gradient
        const boxGradient = ctx.createLinearGradient(x - 15, y - 15, x + 15, y + 15);
        boxGradient.addColorStop(0, '#E0E0E0');
        boxGradient.addColorStop(1, '#A0A0A0');
        ctx.fillStyle = boxGradient;
        ctx.fillRect(x - 15, y - 15, 30, 30);
        
        ctx.strokeStyle = '#505050';
        ctx.lineWidth = 2;
        ctx.strokeRect(x - 15, y - 15, 30, 30);
      });
    }
    
    function drawVehicles() {
      if (!gameState || !gameState.vehicles) return;
      
      gameState.vehicles.forEach(vehicle => {
        const x = vehicle.x - camera.x;
        const y = vehicle.y - camera.y;
        
        // Shadow
        ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
        ctx.fillRect(x - 28, y - 13, 56, 32);
        
        // Vehicle body gradient
        const bodyGradient = ctx.createLinearGradient(x - 25, y - 15, x + 25, y + 15);
        bodyGradient.addColorStop(0, vehicle.occupied ? '#FF6B6B' : '#5AA9E6');
        bodyGradient.addColorStop(1, vehicle.occupied ? '#CC5555' : '#4589C6');
        ctx.fillStyle = bodyGradient;
        ctx.fillRect(x - 25, y - 15, 50, 30);
        
        ctx.strokeStyle = '#2C3E50';
        ctx.lineWidth = 2;
        ctx.strokeRect(x - 25, y - 15, 50, 30);
        
        // Windows
        ctx.fillStyle = 'rgba(100, 150, 200, 0.5)';
        ctx.fillRect(x - 15, y - 10, 12, 8);
        ctx.fillRect(x + 3, y - 10, 12, 8);
        
        // Wheels with gradient
        ctx.fillStyle = '#1A1A1A';
        ctx.beginPath();
        ctx.arc(x - 15, y + 15, 6, 0, Math.PI * 2);
        ctx.arc(x + 15, y + 15, 6, 0, Math.PI * 2);
        ctx.fill();
      });
    }
    
    function drawBullets() {
      if (!gameState || !gameState.bullets) return;
      
      gameState.bullets.forEach(bullet => {
        const x = bullet.x - camera.x;
        const y = bullet.y - camera.y;
        
        // Bullet trail
        ctx.strokeStyle = 'rgba(255, 255, 100, 0.3)';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(x - bullet.vx * 20, y - bullet.vy * 20);
        ctx.stroke();
        
        // Bullet
        ctx.fillStyle = '#FFD700';
        ctx.shadowColor = '#FFA500';
        ctx.shadowBlur = 10;
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;
      });
    }
    
    function drawPlayers() {
      if (!players || players.length === 0) return;
      
      players.forEach(player => {
        if (!player.isAlive) return;
        
        const x = player.x - camera.x;
        const y = player.y - camera.y;
        const isMe = player.id === socket.id;
        const size = 30; // Robot size
        
        // Shadow
        ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
        ctx.beginPath();
        ctx.ellipse(x, y + size + 5, size * 0.8, size * 0.3, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Player glow
        const glowColor = isMe ? 'rgba(0, 255, 0, 0.3)' : 'rgba(255, 0, 0, 0.3)';
        const playerGradient = ctx.createRadialGradient(x, y, 5, x, y, size + 15);
        playerGradient.addColorStop(0, glowColor);
        playerGradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
        ctx.fillStyle = playerGradient;
        ctx.fillRect(x - size - 15, y - size - 15, size * 2 + 30, size * 2 + 30);
        
        // Draw robot character!
        const skinId = player.skin || 'default';
        try {
          if (typeof CharacterRenderer !== 'undefined' && CharacterRenderer.render) {
            ctx.save();
            ctx.translate(x, y);
            CharacterRenderer.render(ctx, skinId, size);
            ctx.restore();
          } else {
            // Fallback to circle if renderer not loaded
            const bodyGradient = ctx.createRadialGradient(x, y - 5, 5, x, y + 5, size);
            bodyGradient.addColorStop(0, isMe ? '#66FF66' : '#FF6666');
            bodyGradient.addColorStop(1, isMe ? '#00CC00' : '#CC0000');
            ctx.fillStyle = bodyGradient;
            ctx.shadowColor = isMe ? '#00FF00' : '#FF0000';
            ctx.shadowBlur = 15;
            ctx.beginPath();
            ctx.arc(x, y, size * 0.7, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;
            
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.stroke();
          }
        } catch (error) {
          console.error('Error rendering character:', error);
          // Draw simple circle as fallback
          ctx.fillStyle = isMe ? '#00FF00' : '#FF0000';
          ctx.beginPath();
          ctx.arc(x, y, size * 0.7, 0, Math.PI * 2);
          ctx.fill();
        }
        
        // Username
        ctx.fillStyle = '#FFF';
        ctx.strokeStyle = '#000';
        ctx.font = 'bold 14px Arial';
        ctx.textAlign = 'center';
        ctx.lineWidth = 4;
        ctx.strokeText(player.username, x, y - size - 10);
        ctx.fillText(player.username, x, y - size - 10);
        
        // Health bar background
        const barWidth = 50;
        const barHeight = 6;
        const healthPercent = player.health / player.maxHealth;
        
        ctx.fillStyle = '#2C3E50';
        ctx.fillRect(x - barWidth/2, y - size - 20, barWidth, barHeight);
        
        // Health bar foreground
        const healthGradient = ctx.createLinearGradient(x - barWidth/2, 0, x + barWidth/2, 0);
        healthGradient.addColorStop(0, '#FF3B3B');
        healthGradient.addColorStop(1, '#FF6B6B');
        ctx.fillStyle = healthGradient;
        ctx.fillRect(x - barWidth/2, y - size - 20, barWidth * healthPercent, barHeight);
        
        // Health bar border
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 1.5;
        ctx.strokeRect(x - barWidth/2, y - size - 20, barWidth, barHeight);
      });
      
      // Update camera
      const localPlayer = players.find(p => p.id === socket.id);
      if (localPlayer) {
        camera.x = localPlayer.x - canvas.width / 2;
        camera.y = localPlayer.y - canvas.height / 2;
      }
    }
    
    function drawUI() {
      const player = players.find(p => p.id === socket.id);
      if (!player) return;
      
      // Stats panel
      ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
      ctx.fillRect(15, 15, 220, 110);
      ctx.strokeStyle = '#4A90E2';
      ctx.lineWidth = 2;
      ctx.strokeRect(15, 15, 220, 110);
      
      ctx.fillStyle = '#FFF';
      ctx.font = 'bold 16px Arial';
      ctx.textAlign = 'left';
      
      ctx.fillText(`‚ù§Ô∏è Health: ${player.health}/${player.maxHealth}`, 25, 40);
      ctx.fillText(`üõ°Ô∏è Shield: ${player.shield}/${player.maxShield}`, 25, 65);
      ctx.fillText(`üî´ Ammo: ${player.ammo}`, 25, 90);
      ctx.fillText(`‚öîÔ∏è Weapon: ${player.weapon}`, 25, 115);
      
      // Kills
      ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
      ctx.fillRect(canvas.width - 165, 15, 150, 45);
      ctx.strokeStyle = '#E74C3C';
      ctx.lineWidth = 2;
      ctx.strokeRect(canvas.width - 165, 15, 150, 45);
      
      ctx.fillStyle = '#FFF';
      ctx.textAlign = 'right';
      ctx.font = 'bold 20px Arial';
      ctx.fillText(`üíÄ Kills: ${player.kills}`, canvas.width - 25, 45);
    }
    
    // ========== SOCKET LISTENERS FOR GAME ==========
    function setupGameSockets() {
      socket.on('game-update', (data) => {
        // Update players
        if (data.players) {
          players = data.players;
          myPlayer = players.find(p => p.id === socket.id);
        }
        
        // Update game state
        if (!gameState) gameState = {};
        if (data.stormRadius !== undefined) gameState.stormRadius = data.stormRadius;
        if (data.stormCenter) gameState.stormCenter = data.stormCenter;
        if (data.triviaStations) gameState.triviaStations = data.triviaStations;
        if (data.powerups) gameState.powerups = data.powerups;
        if (data.weaponSpawns) gameState.weaponSpawns = data.weaponSpawns;
        if (data.vehicles) gameState.vehicles = data.vehicles;
        if (data.bullets) gameState.bullets = data.bullets;
        if (data.buildings) gameState.buildings = data.buildings;
        if (data.chests) gameState.chests = data.chests;
        
        // UPDATE 3D ENGINE WITH NEW V2!
        if (game3D && data.players && gameState.map) {
          game3D.updatePlayers(data.players, gameState.map.size);
        }
      });
      
      socket.on('chest-opened', (data) => {
        console.log(`üì¶ Opened ${data.chestType} chest!`, data.loot);
        // Show loot notification
        const lootMsg = `Got ${data.loot.weapon.toUpperCase()} + ${data.loot.ammo} ammo!`;
        showNotification(lootMsg, data.chestType);
      });
      
      socket.on('player-died', (data) => {
        console.log('üíÄ You died!', data);
        
        // Clean up 3D engine
        if (game3D) {
          game3D.destroy();
          game3D = null;
        }
        
        // Hide game screen
        document.getElementById('game-screen').style.display = 'none';
        
        // Show death message
        alert(`üíÄ You were eliminated! Killed by: ${data.killerName}`);
        
        // Return to menu
        showMenuScreen();
      });
      
      socket.on('game-ended', (data) => {
        console.log('üéÆ Game ended!', data);
        
        // Clean up 3D engine
        if (game3D) {
          game3D.destroy();
          game3D = null;
        }
        
        // Hide game screen
        document.getElementById('game-screen').style.display = 'none';
        
        // Show winner alert
        alert(`üéâ Game Over! Winner: ${data.winner}`);
        
        // Return to menu
        showMenuScreen();
      });
    }
    
    function showNotification(message, type) {
      // Create notification element
      const notif = document.createElement('div');
      notif.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        padding: 15px 25px;
        background: ${type === 'legendary' ? '#FFB800' : type === 'epic' ? '#A335EE' : type === 'rare' ? '#0070DD' : '#666'};
        color: white;
        border-radius: 10px;
        font-weight: bold;
        font-size: 16px;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease;
      `;
      notif.textContent = message;
      document.body.appendChild(notif);
      
      // Remove after 3 seconds
      setTimeout(() => {
        notif.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notif.remove(), 300);
      }, 3000);
    }
    
    // ========== GOOGLE SIGN-IN ==========
    function signInWithGoogle() {
      alert('üöß Google Sign-In Coming Soon!\n\nThis feature is being integrated. For now, please:\n‚Ä¢ Create an account with email\n‚Ä¢ Or continue as guest');
    }
    
    // ========== SKIN SELECTOR ==========
    let selectedSkin = 'default';
    
    function loadSkinSelector() {
      const skinGrid = document.getElementById('skin-grid');
      if (!skinGrid) {
        console.warn('Skin grid not found');
        return;
      }
      
      if (typeof CharacterRenderer === 'undefined') {
        console.warn('CharacterRenderer not loaded yet, retrying in 500ms...');
        setTimeout(loadSkinSelector, 500);
        return;
      }
      
      const popularSkins = ['default', 'peely', 'pug', 'cyber_ninja', 'galaxy', 'lava', 'ice', 'golden'];
      const ownedSkins = currentUser?.inventory?.ownedSkins || ['default'];
      
      skinGrid.innerHTML = '';
      
      popularSkins.forEach(skinId => {
        const skin = CharacterRenderer.skins[skinId];
        if (!skin) {
          console.warn(`Skin ${skinId} not found in CharacterRenderer`);
          return;
        }
        
        const isOwned = ownedSkins.includes(skinId);
        const isSelected = skinId === selectedSkin;
        
        const card = document.createElement('div');
        card.className = 'skin-card' + 
          (isSelected ? ' selected' : '') + 
          (!isOwned ? ' locked' : '');
        
        // Only allow selecting owned skins
        if (isOwned) {
          card.onclick = (e) => selectSkin(skinId, e);
        } else {
          card.onclick = () => {
            alert('üîí This skin is locked! Purchase it from the shop.');
          };
        }
        
        const preview = document.createElement('canvas');
        preview.className = 'skin-preview';
        preview.width = 60;
        preview.height = 60;
        
        const ctx = preview.getContext('2d');
        if (!ctx) return;
        
        // Darken if locked
        if (!isOwned) {
          ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
          ctx.fillRect(0, 0, 60, 60);
        }
        
        ctx.save();
        ctx.translate(30, 30);
        if (!isOwned) {
          ctx.globalAlpha = 0.3; // Dim locked skins
        }
        
        try {
          CharacterRenderer.render(ctx, skinId, 20);
        } catch (error) {
          console.error(`Error rendering skin ${skinId}:`, error);
        }
        
        ctx.restore();
        
        // Lock icon
        if (!isOwned) {
          ctx.font = 'bold 24px Arial';
          ctx.textAlign = 'center';
          ctx.fillStyle = '#FFF';
          ctx.strokeStyle = '#000';
          ctx.lineWidth = 3;
          ctx.strokeText('üîí', 30, 35);
          ctx.fillText('üîí', 30, 35);
        }
        
        const name = document.createElement('div');
        name.className = 'skin-name';
        name.textContent = skin.name;
        
        card.appendChild(preview);
        card.appendChild(name);
        skinGrid.appendChild(card);
      });
    }
    
    function selectSkin(skinId, event) {
      const ownedSkins = currentUser?.inventory?.ownedSkins || ['default'];
      
      // Check if owned
      if (!ownedSkins.includes(skinId)) {
        alert('üîí You don\'t own this skin! Buy it from the shop.');
        return;
      }
      
      selectedSkin = skinId;
      
      // Update UI - remove selected from all cards
      document.querySelectorAll('.skin-card').forEach(card => {
        card.classList.remove('selected');
      });
      
      // Add selected to clicked card (if event provided)
      if (event && event.currentTarget) {
        event.currentTarget.classList.add('selected');
      }
      
      // Save to current user
      if (currentUser && currentUser.inventory) {
        currentUser.inventory.equippedSkin = skinId;
      }
      
      console.log('‚úÖ Selected skin:', skinId);
    }
    
    // ========== AUTH FUNCTIONS ==========

    function createGame() {
      socket.emit('create-game', {
        username: currentUser.username,
        skin: selectedSkin || 'default'
      });
    }

    // Auto-login if token exists
    window.addEventListener('load', () => {
      const savedToken = localStorage.getItem('authToken');
      if (savedToken) {
        authToken = savedToken;
        fetch('/api/auth/profile', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        })
        .then(res => res.json())
        .then(data => {
          if (data.id) {
            currentUser = data;
            connectToGame();
          } else {
            localStorage.removeItem('authToken');
          }
        })
        .catch(() => {
          localStorage.removeItem('authToken');
        });
      }
    });
    
    // ========== ADMIN PANEL ==========
    function openAdminPanel() {
      // Double check admin status
      if (!currentUser || !currentUser.isAdmin) {
        alert('‚ùå Access Denied: Admin privileges required');
        return;
      }
      
      document.getElementById('admin-panel').style.display = 'block';
      loadAdminData();
    }
    
    function closeAdminPanel() {
      document.getElementById('admin-panel').style.display = 'none';
    }
    
    function switchAdminTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.remove('active');
        tab.style.borderBottomColor = 'transparent';
      });
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      document.querySelector(`[data-tab="${tabName}"]`).style.borderBottomColor = '#667eea';
      
      // Update content
      document.querySelectorAll('.admin-tab-content').forEach(content => {
        content.style.display = 'none';
      });
      document.getElementById(`admin-tab-${tabName}`).style.display = 'block';
      
      // Load data for tab
      if (tabName === 'players') loadAdminPlayers();
      if (tabName === 'games') loadAdminGames();
    }
    
    async function loadAdminData() {
      await loadAdminPlayers();
    }
    
    async function loadAdminPlayers() {
      try {
        const response = await fetch('/api/admin/users', {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        const data = await response.json();
        
        if (data.success) {
          displayAdminPlayers(data.users);
        }
      } catch (error) {
        console.error('Error loading players:', error);
      }
    }
    
    function displayAdminPlayers(users) {
      const list = document.getElementById('admin-players-list');
      if (!users || users.length === 0) {
        list.innerHTML = '<p style="color: #888;">No players found</p>';
        return;
      }
      
      list.innerHTML = users.map(user => `
        <div style="background: #222; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="font-size: 16px; font-weight: 600; margin-bottom: 5px;">${user.username}</div>
            <div style="font-size: 12px; color: #888;">
              Coins: ${user.stats?.coins || 0} | 
              Games: ${user.stats?.gamesPlayed || 0} | 
              Wins: ${user.stats?.wins || 0} |
              Banned: ${user.banned ? '‚úÖ Yes' : '‚ùå No'}
            </div>
          </div>
          <div style="display: flex; gap: 10px;">
            ${user.banned 
              ? `<button onclick="unbanPlayer('${user._id}')" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">Unban</button>`
              : `<button onclick="banPlayer('${user._id}')" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">Ban</button>`
            }
          </div>
        </div>
      `).join('');
    }
    
    function searchAdminPlayers() {
      const searchTerm = document.getElementById('admin-player-search').value.toLowerCase();
      const playerDivs = document.querySelectorAll('#admin-players-list > div');
      
      playerDivs.forEach(div => {
        const username = div.querySelector('div > div').textContent.toLowerCase();
        div.style.display = username.includes(searchTerm) ? 'flex' : 'none';
      });
    }
    
    async function banPlayer(userId) {
      if (!confirm('Are you sure you want to ban this player?')) return;
      
      try {
        const response = await fetch('/api/admin/ban-user', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ userId })
        });
        
        const data = await response.json();
        if (data.success) {
          alert('Player banned successfully!');
          loadAdminPlayers();
        } else {
          alert('Failed to ban player: ' + data.message);
        }
      } catch (error) {
        alert('Error banning player: ' + error.message);
      }
    }
    
    async function unbanPlayer(userId) {
      try {
        const response = await fetch('/api/admin/unban-user', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ userId })
        });
        
        const data = await response.json();
        if (data.success) {
          alert('Player unbanned successfully!');
          loadAdminPlayers();
        } else {
          alert('Failed to unban player: ' + data.message);
        }
      } catch (error) {
        alert('Error unbanning player: ' + error.message);
      }
    }
    
    async function loadAdminGames() {
      // TODO: Implement active games list
      document.getElementById('admin-games-list').innerHTML = '<p style="color: #888;">Active games feature coming soon...</p>';
    }
    
    async function sendAdminBroadcast() {
      const message = document.getElementById('admin-broadcast-message').value.trim();
      if (!message) {
        alert('Please enter a message!');
        return;
      }
      
      try {
        socket.emit('admin-broadcast', { message });
        alert('Message sent to all players!');
        document.getElementById('admin-broadcast-message').value = '';
      } catch (error) {
        alert('Error sending message: ' + error.message);
      }
    }
    
    async function givePlayerCoins() {
      const username = document.getElementById('admin-coins-username').value.trim();
      const amount = parseInt(document.getElementById('admin-coins-amount').value);
      
      if (!username || !amount || amount < 1) {
        alert('Please enter a valid username and amount!');
        return;
      }
      
      try {
        const response = await fetch('/api/admin/give-coins', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, amount })
        });
        
        const data = await response.json();
        if (data.success) {
          alert(`Successfully gave ${amount} coins to ${username}!`);
          document.getElementById('admin-coins-username').value = '';
          document.getElementById('admin-coins-amount').value = '';
        } else {
          alert('Failed to give coins: ' + data.message);
        }
      } catch (error) {
        alert('Error giving coins: ' + error.message);
      }
    }
    
    // Listen for admin broadcasts
    socket.on('admin-message', (data) => {
      // Show notification
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 30px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 9999999;
        max-width: 400px;
        font-size: 16px;
        font-weight: 600;
        animation: slideIn 0.3s ease;
      `;
      notification.innerHTML = `
        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üì¢ Admin Announcement</div>
        <div>${data.message}</div>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    });
    
  </script>

</body>
</html>
